<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能助理 (原子化同步版)</title>
    
    <script src="https://registry.npmmirror.com/tailwindcss-cdn/3.4.10/files/tailwindcss.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        html, body, #root { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .raw-text-expandable { cursor: pointer; }
        .assistant-output {
            line-height: 1.7; font-size: 0.95rem; word-break: break-word; overflow-wrap: break-word;
        }
        .assistant-output strong { color: #1e293b; }
        .assistant-output ul { list-style-type: disc; padding-left: 24px; margin-top: 8px; }
        .assistant-output li { margin-bottom: 4px; }
        .assistant-output p { margin-bottom: 12px; }
        .assistant-output p:last-child { margin-bottom: 0; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 图标组件 (无修改) ---
        const Icon = ({ children, className = '', size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const NotebookPenIcon = (props) => (
            <Icon {...props}>
                <path d="M13.4 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7.4"/>
                <path d="M2 6h4"/>
                <path d="M2 10h4"/>
                <path d="M2 14h4"/>
                <path d="M2 18h4"/>
                <path d="M21.378 5.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/>
            </Icon>
        );
        const CalendarIcon = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const MapPin = (props) => <Icon {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></Icon>;
        const Tag = (props) => <Icon {...props}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></Icon>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const BrainCircuit = (props) => <Icon {...props}><path d="M12 5a3 3 0 1 0-5.993.142"/><path d="M18 5a3 3 0 1 0-5.993.142"/><path d="M12 19a3 3 0 1 0 5.993-.142"/><path d="M6 19a3 3 0 1 0 5.993-.142"/><path d="M12 12a3 3 0 1 0-5.993.142"/><path d="M18 12a3 3 0 1 0-5.993.142"/><path d="M6 5h.01"/><path d="M18 5h.01"/><path d="M6 12h.01"/><path d="M18 12h.01"/><path d="M6 19h.01"/><path d="M18 19h.01"/><path d="M12 5h.01"/><path d="M12 12h.01"/><path d="M12 19h.01"/><path d="m14.65 6.05.01.01"/><path d="m14.65 12.05.01.01"/><path d="m14.65 18.05.01.01"/><path d="m9.35 6.05-.01.01"/><path d="m9.35 12.05-.01.01"/><path d="m9.35 18.05-.01.01"/><path d="M12 2v.01"/><path d="M12 8v.01"/><path d="M12 14v.01"/><path d="M12 20v.01"/><path d="m15.54 3.54.01.01"/><path d="m15.54 9.54.01.01"/><path d="m15.54 15.54.01.01"/><path d="m8.46 3.54-.01.01"/><path d="m8.46 9.54-.01.01"/><path d="m8.46 15.54-.01.01"/><path d="M22 12h-.01"/><path d="M16 12h-.01"/><path d="M8 12h-.01"/><path d="M2 12h-.01"/><path d="m20.46 8.46.01.01"/><path d="m20.46 14.46.01.01"/><path d="m3.54 8.46-.01.01"/><path d="m3.54 14.46-.01.01"/></Icon>;
        const Target = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Edit = (props) => <Icon {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const XCircleIcon = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></Icon>;
        const Lightbulb = (props) => <Icon {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></Icon>;
        const Bot = (props) => <Icon {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></Icon>;
        const ClipboardCheck = (props) => <Icon {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></Icon>;
        const List = (props) => <Icon {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Icon>;
        const Loader = ({ className, size=24, ...props }) => (<svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width={size} height={size} {...props}><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>);
        const LayoutGrid = (props) => <Icon {...props}><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><circle cx="12" cy="13" r="2"/><path d="M12 15v5"/></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></Icon>;
        const ChevronLeft = (props) => <Icon {...props}><path d="m15 18-6-6 6-6"/></Icon>;
        const ChevronRight = (props) => <Icon {...props}><path d="m9 18 6-6-6-6"/></Icon>;
        const Repeat = (props) => <Icon {...props}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></Icon>;
        const Send = (props) => <Icon {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></Icon>;
        const Square = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2"/></Icon>;
        const Layers = (props) => <Icon {...props}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.84l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.84Z"/><path d="m22 17.65-8.58 3.91a2 2 0 0 1-1.66 0L3.18 17.65a1 1 0 0 1 0-1.84l8.58-3.91a2 2 0 0 1 1.66 0l8.58 3.91a1 1 0 0 1 0 1.84Z"/></Icon>;
        const Check = (props) => <Icon {...props}><path d="M20 6 9 17l-5-5"/></Icon>;
        const Folder = (props) => <Icon {...props}><path d="M22 7.5V11h-4a2 2 0 0 1-2-2V7.5a2.5 2.5 0 0 1 5 0ZM2 11.5V17a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5.5a2.5 2.5 0 0 0-5 0V14a2 2 0 0 1-2-2h-4a2 2 0 0 1-2-2V7.5a2.5 2.5 0 0 0-5 0v4Z"/></Icon>;
        const Bookmark = (props) => <Icon {...props}><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></Icon>;
        const SproutIcon = (props) => (
            <Icon {...props}>
                <path d="M14 9.536V7a4 4 0 0 1 4-4h1.5a.5.5 0 0 1 .5.5V5a4 4 0 0 1-4 4 4 4 0 0 0-4 4c0 2 1 3 1 5a5 5 0 0 1-1 3"/>
                <path d="M4 9a5 5 0 0 1 8 4 5 5 0 0 1-8-4"/>
                <path d="M5 21h14"/>
            </Icon>
        );
        const BotMessageSquareIcon = (props) => (
            <Icon {...props}>
                <path d="M12 6V2H8"/>
                <path d="M15 11v2"/>
                <path d="M2 12h2"/>
                <path d="M20 12h2"/>
                <path d="M20 16a2 2 0 0 1-2 2H8.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 4 20.286V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2z"/>
                <path d="M9 11v2"/>
            </Icon>
        );

        const Users = (props) => (
            <Icon {...props}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </Icon>
        );

        function Toast({ message, type, onHide }) {
            useEffect(() => {
                const timer = setTimeout(onHide, 3000);
                return () => clearTimeout(timer);
            }, [onHide]);
            const typeClasses = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            return (<div className={`fixed top-2 left-5 z-50 px-3 py-1.5 rounded-md shadow-lg text-white text-xs transition-all duration-300 ${typeClasses}`}>{message}</div>);
        }

        const sortTasks = (tasks) => {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            return [...tasks].sort((a, b) => {
                if (a.isCompleted !== b.isCompleted) {
                    return a.isCompleted ? 1 : -1;
                }
                const aDate = a.startDate ? new Date(a.startDate.replace(/-/g, '/')) : null;
                const bDate = b.startDate ? new Date(b.startDate.replace(/-/g, '/')) : null;
                if (!aDate && !bDate) return 0;
                if (!aDate) return 1;
                if (!bDate) return -1;
                if (!a.isCompleted) {
                    const aIsOverdue = aDate < today;
                    const bIsOverdue = bDate < today;
                    if (aIsOverdue !== bIsOverdue) {
                        return aIsOverdue ? -1 : 1;
                    }
                }
                if (a.isCompleted) {
                    return bDate - aDate; 
                } else {
                    return aDate - bDate; 
                }
            });
        };
        const sortByCreatedAt = (items) => {
            const getCreated = (t) => {
                if (t.createdAt) return new Date(t.createdAt);
                if (t.startDate) return new Date(t.startDate.replace(/-/g, '/'));
                return new Date(0);
            };
            return [...items].sort((a, b) => getCreated(b) - getCreated(a));
        };

        const isTodoTask = (task) => {
            return task.type === 'task' && !task.startDate;
        };

        // --- 把它放在所有 Icon 组件之后，App 组件之前 ---

        function CalendarModal({ task, onConfirm, onClose, onClear }) {
            // --- 新增代码：从任务的现有日期初始化，或使用当前时间 ---
            const getInitialDate = () => {
                if (task && task.startDate) {
                    try {
                        return new Date(task.startDate.replace(/-/g, '/'));
                    } catch (e) {
                        return new Date();
                    }
                }
                return new Date();
            };

            const initialDate = getInitialDate();
            const [currentDate, setCurrentDate] = useState(initialDate); // 用于日历翻页
            const [selectedDate, setSelectedDate] = useState(initialDate); // 用于高亮选中的日期

            // --- 新增代码：管理选中的时间 ---
            const [selectedTime, setSelectedTime] = useState(() => {
                // 如果是已存在的任务（有 startDate），则显示它本来的时间
                if (task && task.startDate) {
                    const existingDate = new Date(task.startDate.replace(/-/g, '/'));
                    const hours = existingDate.getHours().toString().padStart(2, '0');
                    const minutes = existingDate.getMinutes().toString().padStart(2, '0');
                    return `${hours}:${minutes}`;
                }
                // 如果是新任务（没有 startDate，比如点击“待安排”），则默认设置为 08:00
                return '08:00';
            });


            const changeMonth = (offset) => {
                setCurrentDate(prevDate => {
                    const newDate = new Date(prevDate);
                    newDate.setMonth(newDate.getMonth() + offset);
                    return newDate;
                });
            };

            const handleDayClick = (day) => {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                setSelectedDate(date);
            };

            const handleReshapeFieldChange = (e) => {
                const { name, value } = e.target;
                setReshapingTask(prev => ({ ...prev, [name]: value }));
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                const blanks = Array(firstDayOfMonth).fill(null);
                const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

                return (
                    <div>
                        <div className="grid grid-cols-7 gap-2 text-center text-xs text-gray-500 mb-2">
                            {['日', '一', '二', '三', '四', '五', '六'].map(day => <div key={day}>{day}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                            {blanks.map((_, i) => <div key={`blank-${i}`}></div>)}
                            {days.map(day => {
                                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                                const isSelected = selectedDate && day === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear();

                                let dayClasses = "w-10 h-10 flex items-center justify-center rounded-full cursor-pointer transition-colors ";
                                if (isSelected) {
                                    dayClasses += "bg-blue-500 text-white font-bold";
                                } else if (isToday) {
                                    dayClasses += "bg-blue-100 text-blue-600";
                                } else {
                                    dayClasses += "text-gray-700 hover:bg-gray-100";
                                }

                                return (
                                    <div key={day} className={dayClasses} onClick={() => handleDayClick(day)}>
                                        {day}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white p-5 rounded-xl shadow-xl w-full max-w-sm" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">为任务安排日期与时间</h3>
                        <p className="text-sm text-gray-500 mb-4 truncate">任务: {task.title}</p>

                        <div className="flex items-center justify-between mb-4">
                            <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-100"><ChevronLeft size={20}/></button>
                            <span className="font-semibold text-gray-700">{`${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-100"><ChevronRight size={20}/></button>
                        </div>

                        {renderCalendar()}

                        {/* --- 新增代码：时间输入框 --- */}
                        <div className="mt-4">
                            <label className="text-sm font-medium text-gray-700">选择时间</label>
                            <input 
                                type="time" 
                                value={selectedTime}
                                onChange={(e) => setSelectedTime(e.target.value)}
                                className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none"
                            />
                        </div>

                        <div className="flex justify-between items-center mt-5 pt-4 border-t">
                            {/* --- START: 新增的清除按钮 --- */}
                            <button
                                onClick={() => onClear(task)}
                                className="px-4 py-2 text-sm text-red-600 bg-red-100 rounded-md hover:bg-red-200 transition-colors"
                            >
                                清除安排
                            </button>
                            {/* --- END: 新增结束 --- */}

                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                                <button 
                                    onClick={() => onConfirm(task, selectedDate, selectedTime)} 
                                    disabled={!selectedDate}
                                    className="px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed"
                                >
                                    确定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        // --- START: 新增的笔记本编辑器组件 ---
        function NotebookEditorModal({ task, allNotebooks, onSave, onClose }) {
            const [selectedNotebooks, setSelectedNotebooks] = useState(() => new Set(task.notebooks || []));

            const handleToggle = (notebook) => {
                setSelectedNotebooks(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(notebook)) {
                        newSet.delete(notebook);
                    } else {
                        newSet.add(notebook);
                    }
                    return newSet;
                });
            };

            const handleSave = () => {
                onSave(task.id, Array.from(selectedNotebooks));
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white p-5 rounded-xl shadow-xl w-full max-w-sm" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">编辑笔记本分类</h3>
                        <p className="text-sm text-gray-500 mb-4 truncate">记录: {task.title}</p>

                        <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                            {allNotebooks.map(notebook => (
                                <label key={notebook} className="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={selectedNotebooks.has(notebook)}
                                        onChange={() => handleToggle(notebook)}
                                        className="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                    />
                                    <span className="text-sm text-gray-700">{notebook}</span>
                                </label>
                            ))}
                        </div>

                        <div className="flex justify-end gap-3 mt-5 pt-4 border-t">
                            <button onClick={onClose} className="px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                            <button onClick={handleSave} className="px-4 py-2 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600">
                                保存
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        // --- END: 新增组件结束 ---
        function App() {
            const hasTimeInfoRegex = /今天|明天|后天|昨天|早上|上午|中午|下午|晚上|周|星期|\d|月|号|日|点|:|：/;
            const [tasks, setTasks] = useState([]);
            const [workRecordNotebooks, setWorkRecordNotebooks] = useState([]); 
            const [currentView, setCurrentView] = useState('list');
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [editingTask, setEditingTask] = useState(null); 
            const [taskToDelete, setTaskToDelete] = useState(null);
            const [taskToUncomplete, setTaskToUncomplete] = useState(null);
            const [nestedInsightToDelete, setNestedInsightToDelete] = useState(null);
            const [reshapingTask, setReshapingTask] = useState(null);
            const [reshapeInputValue, setReshapeInputValue] = useState('');
            const [isReshaping, setIsReshaping] = useState(false);
            const [expandedRawTextId, setExpandedRawTextId] = useState(null);
            const [assistingTask, setAssistingTask] = useState(null);
            const [assistantMessages, setAssistantMessages] = useState([]);
            const [assistantUserInput, setAssistantUserInput] = useState('');
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [isConnected, setIsConnected] = useState(false);
            const [viewingTask, setViewingTask] = useState(null);
            const [assigningProjectTask, setAssigningProjectTask] = useState(null);
            const [viewingInsight, setViewingInsight] = useState(null);
            const [conversionConfirm, setConversionConfirm] = useState(null);
            const [schedulingTask, setSchedulingTask] = useState(null);
            const [creatingFollowUpForTask, setCreatingFollowUpForTask] = useState(null);
            const [shouldUpdateDateTime, setShouldUpdateDateTime] = useState(true); 
            const [editingNotebooksTask, setEditingNotebooksTask] = useState(null);

            const openNotebookEditor = (task) => {
                setEditingNotebooksTask(task);
            };

            const handleSaveNotebooks = (taskId, newNotebooks) => {
                sendAtomicUpdate('update', { id: taskId, notebooks: newNotebooks }, 'task', `更新ID ${taskId} 的笔记本分类`);
                setEditingNotebooksTask(null); // 关闭弹窗
            };
            const ws = useRef(null);
            const aiAbortRef = useRef(null);
            const contentRef = useRef(null);
            const touchStartX = useRef(0);
            const touchStartY = useRef(0);
            const assistantChatContainerRef = useRef(null);
            const assistantChatEndRef = useRef(null);

            // 为每个会话生成一个简单的、临时的用户ID
            const userId = useMemo(() => 'user_' + Math.random().toString(36).substr(2, 9), []);

            // --- 核心重构: 原子化更新函数 ---
            const sendAtomicUpdate = useCallback((action, data, entity = 'task', logAction) => {
                if (ws.current && ws.current.readyState === WebSocket.OPEN) {
                    const payload = {
                        entity,
                        action,
                        data,
                        userId, // 附带用户ID，便于服务端日志追踪
                        logAction // 附带人类可读的日志信息
                    };
                    ws.current.send(JSON.stringify({ type: 'atomicUpdate', payload }));
                } else {
                    console.error("WebSocket is not connected. Action was not sent.");
                    setToast({ show: true, message: '网络连接已断开，操作失败', type: 'error' });
                }
            }, [userId]); // 依赖于 userId

            // --- 核心重构: WebSocket 连接与消息处理 ---
            useEffect(() => {
                const wsUrl = `ws://${window.location.host}`;

                function connect() {
                    ws.current = new WebSocket(wsUrl);

                    ws.current.onopen = () => {
                        console.log('成功连接到服务器!');
                        setIsConnected(true);
                        setToast({ show: true, message: '已连接', type: 'success' });
                    };

                    ws.current.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        switch (message.type) {
                            case 'initialState': // 首次连接时，服务器发送的完整数据
                                console.log('收到初始数据。');
                                // [核心修改] 同时设置 tasks 和 notebooks
                                setTasks(message.payload.tasks || []);
                                setWorkRecordNotebooks(message.payload.notebooks || []);
                                break;
                            case 'dbUpdated': // 每当有更新时，服务器广播的最新完整数据
                                console.log('数据库已更新，同步本地状态。');
                                // [核心修改] 同时设置 tasks 和 notebooks
                                setTasks(message.payload.tasks || []);
                                setWorkRecordNotebooks(message.payload.notebooks || []);
                                break;
                            default:
                                console.log('收到未知服务器消息:', message.type);
                        }
                    };

                    ws.current.onclose = () => {
                        console.log('与服务器断开连接，3秒后尝试重连...');
                        setIsConnected(false); 
                        setTimeout(connect, 3000); 
                    };

                    ws.current.onerror = (error) => {
                        console.error('WebSocket 错误:', error);
                        setIsConnected(false);
                        ws.current.close(); 
                    };
                }

                connect();

                return () => {
                    if (ws.current) {
                        ws.current.onclose = null;
                        ws.current.close();
                    }
                };
            }, []); // 空依赖数组，确保此 effect 只在组件挂载时运行一次

            useEffect(() => {
                const container = assistantChatContainerRef.current;
                if (!container || !assistingTask) return;
                const lastMessage = assistantMessages[assistantMessages.length - 1];
                if (!lastMessage) return;
                const userJustSent = lastMessage.role === 'user';
                const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 30;
                if (userJustSent || isScrolledToBottom) {
                    assistantChatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                }
            }, [assistantMessages, assistingTask]);

            const views = ['list', 'todo', 'schedule', 'awaiting', 'projects', 'ideas', 'work_records', 'assistant', 'insights', 'settings'];

            const handleSwipeNavigation = useCallback((direction) => {
                const currentIndex = views.indexOf(currentView);
                let nextIndex;
                if (direction === 'next') {
                    nextIndex = (currentIndex + 1) % views.length;
                } else {
                    nextIndex = (currentIndex - 1 + views.length) % views.length;
                }
                setCurrentView(views[nextIndex]);
            }, [currentView, views]);

            useEffect(() => {
                const contentElement = contentRef.current;
                const handleTouchStart = (e) => {
                    if (['INPUT', 'TEXTAREA', 'BUTTON'].includes(e.target.tagName)) return;
                    touchStartX.current = e.targetTouches[0].clientX;
                    touchStartY.current = e.targetTouches[0].clientY;
                };
                const handleTouchEnd = (e) => {
                    if (touchStartX.current === 0) return;
                    if (taskToDelete || reshapingTask || assistingTask) {
                        touchStartX.current = 0;
                        touchStartY.current = 0;
                        return;
                    }
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    const dx = touchEndX - touchStartX.current;
                    const dy = touchEndY - touchStartY.current;
                    const swipeThreshold = 50;
                    if (Math.abs(dx) > swipeThreshold && Math.abs(dx) > Math.abs(dy)) {
                        if (dx < 0) {
                            handleSwipeNavigation('next');
                        } else {
                            handleSwipeNavigation('prev');
                        }
                    }
                    touchStartX.current = 0;
                    touchStartY.current = 0;
                };
                if (contentElement) {
                    contentElement.addEventListener('touchstart', handleTouchStart, { passive: true });
                    contentElement.addEventListener('touchend', handleTouchEnd, { passive: true });
                }
                return () => {
                    if (contentElement) {
                        contentElement.removeEventListener('touchstart', handleTouchStart);
                        contentElement.removeEventListener('touchend', handleTouchEnd);
                    }
                };
            }, [handleSwipeNavigation, taskToDelete, reshapingTask, assistingTask]);
            
                useEffect(() => {
                    // 1. 找到所有被标记为 "新" 的任务
                    const newTasks = tasks.filter(t => t.isNew);

                    // 2. 如果找到了任何新任务
                    if (newTasks.length > 0) {
                        // 3. 设置一个2秒的计时器，让绿色框显示一会儿
                        const timer = setTimeout(() => {
                            // 4. 计时结束后，遍历每一个新任务
                            newTasks.forEach(task => {
                                // 5. 向服务器发送一个 "update" 指令，
                                //    只将这个任务的 isNew 属性更新为 false
                                sendAtomicUpdate(
                                    'update', 
                                    { id: task.id, isNew: false }, 
                                    'task', 
                                    `清除任务 ${task.id} 的“新”状态`
                                );
                            });
                        }, 2000); // 绿色框显示2秒

                        // 这是一个清理函数，防止在计时器完成前发生意外情况
                        return () => clearTimeout(timer);
                    }
                }, [tasks, sendAtomicUpdate]); // 注意：依赖项数组需要加入 sendAtomicUpdate
            
            const formatDateRange = (startDateStr, endDateStr, rawText = '') => {
                if (!startDateStr) return null;
                const formatDatePart = (date) => {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const taskDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                    if (taskDate.getTime() === today.getTime()) return '今天';
                    if (taskDate.getTime() === tomorrow.getTime()) return '明天';
                    return date.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
                };
                const formatTimePart = (date) => { return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }); };
                try {
                    const start = new Date(startDateStr.replace(/-/g, '/'));
                    if (isNaN(start.getTime())) return startDateStr;
                    
                    const hasSpecificTime = /[0-9](:|：|点)|(上|下|中)午|凌晨|晚上|am|pm/i.test(rawText || '');
                    const isMidnight = startDateStr.endsWith('00:00:00');
                    const shouldShowTime = !isMidnight || hasSpecificTime;

                    if (!endDateStr) {
                         return shouldShowTime 
                            ? `${formatDatePart(start)} ${formatTimePart(start)}`
                            : formatDatePart(start);
                    }
                    const end = new Date(endDateStr.replace(/-/g, '/'));
                    if (isNaN(end.getTime())) {
                        return shouldShowTime 
                            ? `${formatDatePart(start)} ${formatTimePart(start)}`
                            : formatDatePart(start);
                    }
                    const startDayStr = start.toLocaleDateString();
                    const endDayStr = end.toLocaleDateString();
                    if (startDayStr === endDayStr) {
                        return `${formatDatePart(start)} ${formatTimePart(start)} - ${formatTimePart(end)}`;
                    } else {
                        return `${start.toLocaleDateString('zh-CN')} → ${end.toLocaleDateString('zh-CN')}`;
                    }
                } catch (e) { return startDateStr; }
            };

            const formatCreationTime = (dateString) => {
                if (!dateString) return '';
                try {
                    const d = new Date(dateString);
                    const year = d.getFullYear();
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const day = d.getDate().toString().padStart(2, '0');
                    const hour = d.getHours().toString().padStart(2, '0');
                    const minute = d.getMinutes().toString().padStart(2, '0');
                    return `${year}-${month}-${day} ${hour}:${minute}`;
                } catch (e) { return dateString; }
            };
            
            const getTagColor = (tag) => {
                const colors = { '工作': 'bg-blue-100 text-blue-800', '会议': 'bg-purple-100 text-purple-800', '生活': 'bg-green-100 text-green-800', '购物': 'bg-yellow-100 text-yellow-800', '个人': 'bg-indigo-100 text-indigo-800', '紧急': 'bg-red-100 text-red-800', '旅游': 'bg-pink-100 text-pink-800', '想法': 'bg-orange-100 text-orange-800', '工作记录': 'bg-indigo-100 text-indigo-800', '健康': 'bg-teal-100 text-teal-800', 'AI': 'bg-cyan-100 text-cyan-800', '家庭': 'bg-rose-100 text-rose-800', '财务': 'bg-amber-100 text-amber-800', '代办': 'bg-lime-100 text-lime-800', '社交': 'bg-pink-100 text-pink-800', '宠物': 'bg-fuchsia-100 text-fuchsia-800', '团建': 'bg-sky-100 text-sky-800', 'AI洞察': 'bg-blue-100 text-blue-800' };
                return colors[tag] || 'bg-gray-100 text-gray-800';
            };

            const callArkApi = async (requestData, stream = false, signal) => {
                let payload;
                if (typeof requestData === 'string') {
                    payload = { prompt: requestData, stream };
                } else {
                    payload = requestData;
                }
                const response = await fetch('/api/ark-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`AI 代理请求失败: ${errorBody.error || response.statusText}`);
                }

                if (stream) {
                    return response.body.getReader();
                } else {
                    const result = await response.json();
                    const aiResponseText = result.choices[0].message.content;
                    const cleanedText = aiResponseText.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                    try {
                        return JSON.parse(cleanedText);
                    } catch (e) {
                        throw new Error(`AI返回了非JSON格式的文本: ${cleanedText}`);
                    }
                }
            };
            
            // --- 核心重构: 修改所有数据操作函数 ---

            // ... 在 App 组件内部，靠近其他 handler 函数的地方

            // 打开日历弹窗的函数
            const openCalendarScheduler = (task) => {
                setSchedulingTask(task);
            };

            // 当用户在日历中点击“确定”后调用的函数
            const handleScheduleTask = (task, date, time) => {
                if (!task || !date) return;

                // --- 修改：结合日期和时间来生成最终的 startDate ---
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');

                // 如果用户没有选择时间（虽然我们给了默认值，但以防万一），则默认为 00:00
                const timePart = time ? `${time}:00` : '00:00:00';

                const newStartDate = `${year}-${month}-${day} ${timePart}`;

                sendAtomicUpdate(
                    'update',
                    { id: task.id, startDate: newStartDate, isNew: true },
                    'task',
                    `为任务 "${task.title}" 重新安排时间`
                );

                setSchedulingTask(null); 
            };

            const handleClearSchedule = (task) => {
                if (!task) return;
                sendAtomicUpdate(
                    'update',
                    { id: task.id, startDate: null, endDate: null, isNew: true },
                    'task',
                    `清除任务 "${task.title}" 的日程安排`
                );
                setSchedulingTask(null); // 关闭弹窗
            };

            // ...        

            const handleAddTask = async () => {
                if (!inputValue.trim()) return;
                setIsLoading(true);
                setError('');
                const prompt = `你是一个强大的内容分析助手。请先判断以下用户输入是“任务”、“生活想法”还是“工作记录”，然后严格按照JSON数组的格式返回分析结果。“任务”通常有明确的动作和时间意图。“生活想法”是关于个人生活的概念、计划或灵感。“工作记录”是关于工作过程中发现的问题、工艺知识、生产问题或管理问题等的客观记录。- 今天的日期是: ${new Date().toLocaleDateString('sv')} - 文本内容: "${inputValue}" 对于每个识别出的条目，请提取以下信息: - type (string): "task", "idea" (生活想法), 或 "work_record" (工作记录)。- title (string): 核心标题。- startDate (string): 开始日期时间 ("YYYY-MM-DD HH:mm:ss")，请遵循以下精确规则： - **处理模糊时间：** 如果用户提到模糊的时间段，请按以下规则转换为大概时间：'早上'或'上午'设为'09:00:00'，'中午'设为'12:00:00'，'下午'设为'14:00:00'，'晚上'设为'20:00:00'。例如，“明天下午”应解析为明天的 "14:00:00"。 - **处理无时间：** 如果用户输入中完全没有像'今天'、'明天'、'下午3点'、'周五'这样的时间或日期词汇，\`startDate\`字段的值**必须强制设为\`null\`**。不要从'记得'、'需要'等动词中推断任何时间。例如，输入'打电话给爸爸'，\`startDate\`必须是\`null\`。 - **处理无具体时间：** 如果用户只提供了日期但没有具体时间或模糊时间段（如“明天开会”），则时间部分应设为 "00:00:00"。- endDate (string): 结束日期时间 ("YYYY-MM-DD HH:mm:ss")；单日或无则为 null。- location (string): 地点；记录则为 null。- context (object): [重要] 这是情境对象，包含三个键 "taskType", "locationScene", "category"。请严格从以下选项中为每个键选择一个最匹配的值: - "taskType": 从 ['深度', '常规', '顺手'] 中选择。'深度'指需要长时间专注的任务，'常规'指普通任务，'顺手'指可以碎片化时间完成的快速任务。- "locationScene": 从 ['公司', '家里', '外出', '任何地方'] 中选择。'外出'包括通勤、差旅等。- "category": 从 ['工作', '生活'] 中选择。如果某个维度不适用，请将其值设为 null。例如: {"taskType": "深度", "locationScene": "公司", "category": "工作"}。- tags (array of strings): 1-3个相关标签。生活想法必须包含 "想法" 标签，工作记录必须包含 "工作记录" 标签。请只返回JSON数组本身，不要包含任何额外的解释。- notebooks (array of strings): [新增] 如果 type 是 "work_record"，请从预设的笔记本分类中选择1个最匹配的分类: [${workRecordNotebooks.join(', ')}]。如果 type 不是 "work_record"，这个字段必须是 null。`;
                try {
                    const parsedData = await callArkApi(prompt);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        const containsTimeInfo = hasTimeInfoRegex.test(inputValue);

                        const newItems = parsedData.map(item => {
                            if (!containsTimeInfo && item.startDate) {
                                item.startDate = null; 
                            }
                            
                            return {
                                id: Date.now() + Math.random(),
                                createdAt: new Date().toISOString(),
                                rawText: inputValue,
                                type: item.type || 'task',
                                title: item.title,
                                startDate: item.startDate,
                                endDate: item.endDate,
                                location: item.location,
                                context: item.context,
                                tags: item.tags || [],
                                notebooks: item.notebooks || null,
                                savedInsights: [], 
                                isCompleted: false,
                                isNew: true
                            };
                        }).reverse();
                        
                        newItems.forEach(item => {
                           sendAtomicUpdate('create', item, 'task', `创建任务: ${item.title}`);
                        });
                        setInputValue('');

                    } else { throw new Error("AI未能按预期的数组格式返回。"); }
                } catch (err) {
                    console.error("处理错误:", err);
                    setError(err.message || "无法连接到AI服务，已添加为普通条目。");
                    const fallbackTask = { id: Date.now(), createdAt: new Date().toISOString(), type: 'task', rawText: inputValue, title: inputValue, startDate: null, endDate: null, location: null, context: null, tags: [], savedInsights: [], isCompleted: false, isNew: true };
                    sendAtomicUpdate('create', fallbackTask, 'task', `创建备用任务: ${fallbackTask.title}`);
                    setInputValue('');
                } finally { setIsLoading(false); }
            };

            const handleReshapeFieldChange = (e) => {
                const { name, value } = e.target;
                setReshapingTask(prev => ({ ...prev, [name]: value }));
            };
            
            const handleReshapeTask = async () => {
                if (!reshapingTask) return;
                
                const finalRawText = reshapeInputValue.trim() 
                    ? `${reshapingTask.rawText}\n[补充] ${reshapeInputValue}`
                    : reshapingTask.rawText;

                setIsReshaping(true);
                setError('');
                
                const originalContentJSON = JSON.stringify({
                    title: reshapingTask.title,
                    rawText: reshapingTask.rawText,
                    location: reshapingTask.location || ''
                });

                // --- 核心修改：根据复选框状态，生成不同的 AI 指令 ---
                let prompt;
                if (shouldUpdateDateTime) {
                    // 【状态一：勾选了复选框，智能更新所有信息】
                    prompt = `你是一个强大的任务整合与更新助手。请根据“补充内容”，对“原始内容”进行智能更新。“补充内容”里的信息拥有最高优先级。- 今天的日期是: ${new Date().toLocaleDateString('sv')} - 原始内容: ${originalContentJSON} - 补充内容: ${JSON.stringify(reshapeInputValue)} 请整合所有信息，并严格按照单个JSON对象的格式返回: - title (string): 全新的、更准确的核心标题。- startDate (string): 最终的开始日期时间 ("YYYY-MM-DD HH:mm:ss")。如果用户只提供了日期（如“明天”、“8月26日”）没有具体时间，则时间部分应设为 "00:00:00"。如果用户**完全没有提供任何日期或时间信息**，则必须返回 \`null\`。生活想法或工作记录类型也返回 \`null\`。- endDate (string): 最终的结束日期时间 ("YYYY-MM-DD HH:mm:ss")；单日或无则为 null。- location (string): 地点；想法或记录则为 null。- context (object): [重要] 这是情境对象，包含三个键 "taskType", "locationScene", "category"。请严格从以下选项中为每个键选择一个最匹配的值: - "taskType": 从 ['深度', '常规', '顺手'] 中选择。- "locationScene": 从 ['公司', '家里', '外出', '任何地方'] 中选择。- "category": 从 ['工作', '生活'] 中选择。如果某个维度不适用，请将其值设为 null。例如: {"taskType": "深度", "locationScene": "公司", "category": "工作"}。- tags (array of strings): 1-3个优化后的相关普通标签。如果内容是生活想法，必须包含 "想法" 标签；如果是工作记录，必须包含 "工作记录" 标签。- notebooks (array of strings): [新增] 如果整合后的内容判断为 "work_record" 类型，请从预设的笔记本分类中选择1个最匹配的分类: [${workRecordNotebooks.join(', ')}]。否则，这个字段必须是 null。请只返回JSON对象本身，不要包含任何额外的解释。`;
                } else {
                    // 【状态二：未勾选复选框，只更新文本内容，不碰日期】
                    prompt = `你是一个强大的任务整合与更新助手。请根据“补充内容”，对“原始内容”进行智能更新，但**【非常重要】请完全忽略“补充内容”里的任何日期和时间信息，不要对它们进行任何分析或提取**。“补充内容”里的信息拥有最高优先级。- 原始内容: ${originalContentJSON} - 补充内容: ${JSON.stringify(reshapeInputValue)} 请整合除日期时间以外的所有信息，严格按照单个JSON对象的格式返回: - title (string): 全新的、更准确的核心标题。- startDate (string): **必须返回 null，不要做任何日期分析**。- endDate (string): **必须返回 null，不要做任何日期分析**。- location (string): 更新后的地点。- context (object): 根据所有文本更新后的情境对象 (taskType, locationScene, category)。- tags (array of strings): 1-3个优化后的相关普通标签。- notebooks (array of strings): [新增] 如果整合后的内容判断为 "work_record" 类型，请从预设的笔记本分类中选择1个最匹配的分类: [${workRecordNotebooks.join(', ')}]。否则，这个字段必须是 null。请只返回JSON对象本身，不要包含任何额外的解释。`;
                }

                try {
                    const updatedDataFromAI = await callArkApi(prompt);
                    
                    const updatePayload = {
                        id: reshapingTask.id,
                        ...updatedDataFromAI,
                        rawText: finalRawText,
                        isNew: true
                    };
                    
                    if (!updatePayload.title) updatePayload.title = reshapingTask.title;
                    if (updatedDataFromAI.location === undefined) {
                        updatePayload.location = reshapingTask.location;
                    }
                    
                    // --- 核心修改：如果用户选择不更新日期，则保留原始日期 ---
                    if (!shouldUpdateDateTime) {
                        updatePayload.startDate = reshapingTask.startDate;
                        updatePayload.endDate = reshapingTask.endDate;
                    }

                    sendAtomicUpdate('update', updatePayload, 'task', `重塑任务: ${updatePayload.title}`);

                    setReshapingTask(null);
                    setReshapeInputValue('');
                } catch (err) {
                    console.error("补充想法时出错:", err);
                    setError(err.message || "无法连接到AI服务。");
                } finally {
                    setIsReshaping(false);
                }
            };
            
            const handleGetAssistance = async (item) => {
                if (viewingTask) { setViewingTask(null); }
                setAssistingTask(item);
                
                setAssistantMessages([]);
                setError('');

                const controller = new AbortController();
                aiAbortRef.current = controller;

                let prompt;
                if (item.type === 'project') {
                    const projectItems = tasks.filter(t => t.projectId === item.id);

                    const instruction = `
                    # 重要指令
                    - **今天的日期是: ${new Date().toLocaleDateString('sv')}**。
                    - 在你的分析中，当你提到任何具体的任务或事件时，请**直接使用其绝对日期（例如 '9月5日'）**。
                    - **请避免使用“今天”、“明天”等相对词汇**，除非该相对关系对于今天的日期来说是完全准确的。例如，如果今天是9月5日，那么一个安排在9月6日的任务才可以被称为“明天”。
                    `;
                    prompt = `你好！我希望你扮演一个有创意、善于观察的朋友和项目伙伴的角色。请不要给我生成正式的报告。请用口语化的语气，和我聊聊下面这个项目。

                    ${instruction}
                    项目名称: "${item.title}"

                    这是项目里包含的所有事情:
                    ${JSON.stringify(projectItems.map(({id, rawText, ...rest}) => rest), null, 2)}

                    今天的日期是: ${new Date().toLocaleDateString('sv')}

                    请根据这些信息，给我一些启发性的建议或提醒。你可以从这些角度出发，但不要局限于此：
                    - 这个项目的整体情况怎么样？
                    - 关于进度的推进，我有没有什么做不够好的地方？
                    - 有没有潜在的“思维定势”或者我可以换个角度思考的地方？

                    请用 Markdown 的列表（-）来组织你的回答，回答要简单明了，不要有客套话，让它看起来清晰又有标记易读，并使用 Markdown（例如 **加粗**、- 列表）突出重点。每段有标题。直接开始你的建议，不要有“报告”、“总结”之类的词。`;
                                    } else {
                                        prompt = `你好！请像一个聪明的助理一样，帮我分析一下这个${item.type === 'task' ? '任务' : '想法'}。
                                        请用口语化的语气，直接给我 1-3 个最核心的建议或行动点，并使用 Markdown（例如 **加粗**、- 列表）突出重点。
                                        - 标题: "${item.title}"
                                        - 描述: "${item.rawText}"`;
                                    }
                
                setAssistantMessages([{ role: 'assistant', content: '', loading: true }]);

                try {
                    const reader = await callArkApi({ messages: [{ role: 'user', content: prompt }], stream: true }, true, controller.signal);
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.substring(6).trim();
                                if (jsonStr === '[DONE]') break;
                                try {
                                    const parsed = JSON.parse(jsonStr);
                                    if (parsed.choices && parsed.choices[0]?.delta?.content) {
                                        setAssistantMessages(prev => {
                                            const newMessages = [...prev];
                                            const lastMsg = newMessages[newMessages.length - 1];
                                            if(lastMsg.role === 'assistant') {
                                                lastMsg.content += parsed.choices[0].delta.content;
                                            }
                                            return newMessages;
                                        });
                                    }
                                } catch {}
                            }
                        }
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('AI助理出错:', err);
                        setError(err.message || 'AI助理服务暂时不可用。');
                    }
                } finally {
                    setAssistantMessages(prev => {
                        const newMessages = [...prev];
                        if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
                            newMessages[newMessages.length - 1].loading = false;
                        }
                        return newMessages;
                    });
                    aiAbortRef.current = null;
                }
            };

            const handleContinueAssistantChat = async () => {
                if (!assistantUserInput.trim() || !assistingTask) return;

                const newUserMessage = { role: 'user', content: assistantUserInput };
                const currentHistory = [...assistantMessages, newUserMessage];
                
                setAssistantMessages([...currentHistory, { role: 'assistant', content: '', loading: true }]);
                setAssistantUserInput('');
                setError('');

                const controller = new AbortController();
                aiAbortRef.current = controller;

                let systemPrompt;
                if (assistingTask.type === 'project') {
                    const projectItems = tasks.filter(t => t.projectId === assistingTask.id);
                    systemPrompt = `你是一位资深的AI项目管理专家。你正在就以下项目与用户进行对话。请根据聊天历史和项目数据，继续提供有帮助的建议。
- 项目名称: "${assistingTask.title}"
- 关联条目: ${JSON.stringify(projectItems.map(({id, rawText, ...rest}) => rest))}`;
                } else {
                    systemPrompt = `你是一个聪明的助理。你正在就以下这个${assistingTask.type === 'task' ? '任务' : '想法'}与用户进行对话。请根据聊天历史，继续提供有帮助的建议。
- 标题: "${assistingTask.title}"
- 原始描述: "${assistingTask.rawText}"`;
                }

                const apiMessages = [
                    { role: 'system', content: systemPrompt },
                    ...currentHistory.map(({ role, content }) => ({ role, content }))
                ];
                
                try {
                    const reader = await callArkApi({ messages: apiMessages, stream: true }, true, controller.signal);
                    const decoder = new TextDecoder();
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.substring(6).trim();
                                if (jsonStr === '[DONE]') break;
                                try {
                                    const parsed = JSON.parse(jsonStr);
                                    if (parsed.choices && parsed.choices[0]?.delta?.content) {
                                        setAssistantMessages(prev => {
                                            const newMessages = [...prev];
                                            const lastMsg = newMessages[newMessages.length - 1];
                                            if(lastMsg.role === 'assistant') {
                                                lastMsg.content += parsed.choices[0].delta.content;
                                            }
                                            return newMessages;
                                        });
                                    }
                                } catch {}
                            }
                        }
                    }
                } catch (err) {
                     if (err.name !== 'AbortError') {
                        console.error('AI助理出错:', err);
                        setError(err.message || 'AI助理服务暂时不可用。');
                    }
                } finally {
                    setAssistantMessages(prev => {
                        const newMessages = [...prev];
                        if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
                            newMessages[newMessages.length - 1].loading = false;
                        }
                        return newMessages;
                    });
                    aiAbortRef.current = null;
                }
            };
            
            const handleSaveInsight = (taskId, insightContent) => {
                const newInsight = {
                    id: `insight_${Date.now()}_${Math.random()}`,
                    content: insightContent,
                    savedAt: new Date().toISOString()
                };
                sendAtomicUpdate('updateNested', 
                    { parentId: taskId, action: 'addInsight', insight: newInsight },
                    'task',
                    `为任务 ${taskId} 保存建议`
                );
                setToast({ show: true, message: 'AI 建议已保存', type: 'success' });
            };

            const handleSaveGeneralInsight = (content, userPrompt) => {
                const newInsight = {
                    id: Date.now() + Math.random(),
                    createdAt: new Date().toISOString(),
                    type: 'insight',
                    title: 'AI 亮点回复',
                    content: content,
                    rawText: userPrompt,
                    tags: ['AI洞察'],
                    isNew: true,
                };
                sendAtomicUpdate('create', newInsight, 'task', '保存通用AI洞察');
                setToast({ show: true, message: '亮点回复已保存', type: 'success' });
            };

            const handleDeleteInsight = (taskId, insightId) => {
                setNestedInsightToDelete({ taskId, insightId });
            };
            
            const confirmNestedInsightDelete = () => {
                if (!nestedInsightToDelete) return;
                const { taskId, insightId } = nestedInsightToDelete;
                sendAtomicUpdate('updateNested', 
                    { parentId: taskId, action: 'deleteInsight', insightId: insightId },
                    'task',
                    `从任务 ${taskId} 删除建议`
                );
                setToast({ show: true, message: 'AI 建议已删除', type: 'success' });
                setNestedInsightToDelete(null);
            };

            const cancelNestedInsightDelete = () => {
                setNestedInsightToDelete(null);
            };

            const handleUnifiedDeleteInsight = (insightToDelete) => {
                if (insightToDelete.sourceType === 'assistant') {
                    requestDelete(insightToDelete.id);
                } else {
                    handleDeleteInsight(insightToDelete.sourceId, insightToDelete.id);
                }
            };

            const handleViewFullInsight = (insight) => {
                setViewingInsight(insight);
            };

            const closeAssistantModal = () => {
                if (aiAbortRef.current) {
                    try { aiAbortRef.current.abort(); } catch {}
                    aiAbortRef.current = null;
                }
                setAssistingTask(null);
                setAssistantMessages([]);
                setAssistantUserInput('');
            };
            const openReshapeModal = (task) => { setReshapingTask(task); setReshapeInputValue(''); setError(''); setShouldUpdateDateTime(false);};
            const closeReshapeModal = () => { setReshapingTask(null); setReshapeInputValue(''); };
            const toggleRawText = (id) => { setExpandedRawTextId(prevId => (prevId === id ? null : id)); };
            
            const toggleTaskCompletion = (id) => {
                const task = tasks.find(t => t.id === id);
                if (task) {
                    // 准备要更新的数据
                    const updateData = { id, isCompleted: !task.isCompleted };

                    // 核心改动：检查任务是否从未完成 -> 完成，并且它是一个“待办”任务
                    if (!task.isCompleted && isTodoTask(task)) {
                        // 如果是，就给它设置一个今天的日期，时间设为 00:00:00
                        updateData.startDate = new Date().toISOString().slice(0, 10) + ' 00:00:00';
                    }

                    // 发送更新指令，其中可能包含了新的日期
                    sendAtomicUpdate('update', updateData, 'task', `切换任务完成状态: ${task.title}`);
                }
            };
            
            const handleToggleCompletion = (task) => {
                if (task.isCompleted) {
                    setTaskToUncomplete(task.id);
                } else {
                    toggleTaskCompletion(task.id);
                }
            };

            const confirmUncomplete = () => {
                if (taskToUncomplete) {
                    toggleTaskCompletion(taskToUncomplete);
                    setTaskToUncomplete(null);
                }
            };

            const cancelUncomplete = () => {
                setTaskToUncomplete(null);
            };
            
            const toggleProjectCompletion = (id) => {
                const project = tasks.find(p => p.id === id);
                if (project) {
                    const isNowCompleted = !project.isCompleted;
                    const updateData = {
                        id,
                        isCompleted: isNowCompleted,
                        completionDate: isNowCompleted ? new Date().toISOString() : null
                    };
                    sendAtomicUpdate('update', updateData, 'task', `切换项目完成状态: ${project.title}`);
                }
            };

            const requestDelete = (id) => setTaskToDelete(id);

            const confirmDelete = () => {
                if (!taskToDelete) return;
                const itemToDelete = tasks.find(task => task.id === taskToDelete);
                
                if (itemToDelete && itemToDelete.type === 'project') {
                    // 1. 删除项目本身
                    sendAtomicUpdate('delete', { id: taskToDelete }, 'task', `删除项目: ${itemToDelete.title}`);
                    // 2. 遍历所有任务，解除与该项目的关联
                    tasks.forEach(t => {
                        if (t.projectId === taskToDelete) {
                            sendAtomicUpdate('update', { id: t.id, projectId: null }, 'task', `从已删除的项目中移除任务 ${t.title}`);
                        }
                    });
                } else if (itemToDelete) {
                    // 删除普通任务或想法
                    sendAtomicUpdate('delete', { id: taskToDelete }, 'task', `删除条目: ${itemToDelete.title}`);
                }
                setTaskToDelete(null); 
            };
            const cancelDelete = () => setTaskToDelete(null);
            const startEditing = (task) => setEditingTask({ ...task });
            const cancelEditing = () => setEditingTask(null);
            
            const saveEditing = () => {
                sendAtomicUpdate('update', editingTask, 'task', `保存编辑: ${editingTask.title}`);
                setEditingTask(null); 
            };
            
            const handleEditChange = (e) => {
                const { name, value } = e.target;
                setEditingTask(prev => {
                    if (name.startsWith('startDate')) {
                        const [currentDate, currentTime] = (prev.startDate || `${new Date().toISOString().slice(0,10)} 00:00:00`).split(' ');
                        let newStartDate;
                        if (name === 'startDate_date') {
                            newStartDate = `${value} ${currentTime}`;
                        } else {
                            newStartDate = `${currentDate} ${value ? value + ':00' : '00:00:00'}`;
                        }
                        return { ...prev, startDate: newStartDate };
                    }
                    if (name === 'tags') {
                        return { ...prev, tags: value.split(',').map(tag => tag.trim()) };
                    }
                    // --- START: 新增的逻辑 ---
                    if (name === 'notebooks') {
                        return { ...prev, notebooks: value.split(',').map(notebook => notebook.trim().replace(/，/g, '')) }; // 同时替换中文逗号
                    }
                    // --- END: 新增结束 ---
                    return { ...prev, [name]: value };
                });
            };

            const requestConversion = (task) => {
                setConversionConfirm(task);
            };

            const confirmConversion = (task, targetType) => {
                let updateData;

                // --- 这是我们修改的核心 ---
                // 从 任务 -> 生活想法 或 工作记录
                if (task.type === 'task' && (targetType === 'idea' || targetType === 'work_record')) {
                    const newTags = [...(task.tags || [])];
                    // 自动添加对应的默认标签，避免重复添加
                    if (targetType === 'idea' && !newTags.includes('想法')) {
                        newTags.push('想法');
                    } else if (targetType === 'work_record' && !newTags.includes('工作记录')) {
                        newTags.push('工作记录');
                    }

                    updateData = { 
                        id: task.id, 
                        type: targetType, 
                        startDate: null, 
                        endDate: null, 
                        location: null, 
                        isNew: true,
                        tags: newTags, // 保存更新后的标签
                        notebooks: ['其他'],
                    };
                } 
                // 从 生活想法 或 工作记录 -> 任务 (合并了之前的逻辑)
                else if ((task.type === 'idea' || task.type === 'work_record') && targetType) {
                    const newStartDate = targetType === 'scheduled' 
                        ? new Date().toISOString().slice(0, 10) + ' 00:00:00'
                        : null; 
                    updateData = { id: task.id, type: 'task', startDate: newStartDate, isNew: true };
                } 
                else {
                    console.error("无效的转换操作", task, targetType);
                    setConversionConfirm(null);
                    return;
                }

                sendAtomicUpdate('update', updateData, 'task', `转换条目类型: ${task.title}`);
                setConversionConfirm(null); // 关闭弹窗
            };
            const openTaskViewModal = (task) => setViewingTask(task);
            const closeTaskViewModal = () => {
                setViewingTask(null);
                cancelEditing();
            };
            const handleOpenProjectAssigner = (task) => setAssigningProjectTask(task);
            const handleCloseProjectAssigner = () => setAssigningProjectTask(null);
            
            const handleAssignTaskToProject = (taskId, projectId) => {
                sendAtomicUpdate('update', { id: taskId, projectId }, 'task', `分配任务 ${taskId} 到项目 ${projectId}`);
                handleCloseProjectAssigner();
            };
            const handleRemoveTaskFromProject = (taskId) => {
                sendAtomicUpdate('update', { id: taskId, projectId: null }, 'task', `从项目中移除任务 ${taskId}`);
                handleCloseProjectAssigner();
            };

            const openFollowUpModal = (task) => {
                setCreatingFollowUpForTask(task);
            };

            const handleSaveFollowUp = (followUpData) => {
                sendAtomicUpdate('create', followUpData, 'task', `为任务 ${followUpData.parentId} 创建跟进项`);
            };

            const handlers = {
                startEditing, cancelEditing, saveEditing, handleEditChange, 
                requestConversion, 
                handleToggleCompletion,
                toggleRawText, openReshapeModal,
                requestDelete, handleGetAssistance, getTagColor, formatDateRange, formatCreationTime,
                openTaskViewModal,
                handleOpenProjectAssigner,
                toggleProjectCompletion,
                handleDeleteInsight,
                handleViewFullInsight,
                handleUnifiedDeleteInsight,
                openCalendarScheduler,
                openNotebookEditor,
                openFollowUpModal //
            };
            
            const handleExportData = () => {
                try {
                    const now = new Date();
                    const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                    const fileName = `ai-assistant_backup_${timestamp}.json`;
                    const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(tasks, null, 2))}`;
                    const link = document.createElement("a");
                    link.href = jsonString;
                    link.download = fileName;
                    link.click();
                    setToast({ show: true, message: '数据导出成功！', type: 'success' });
                } catch (error) {
                    setToast({ show: true, message: `导出失败: ${error.message}`, type: 'error' });
                }
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const fileReader = new FileReader();
                fileReader.readAsText(file, "UTF-8");
                fileReader.onload = e => {
                    try {
                        const importedTasks = JSON.parse(e.target.result);
                        if (Array.isArray(importedTasks) && (importedTasks.length === 0 || importedTasks.every(t => typeof t === 'object' && t !== null && 'id' in t && 'title' in t))) {
                            // 对于导入操作，我们发送一个特殊的指令来替换整个数据库
                            sendAtomicUpdate('replaceAll', importedTasks, 'db', `从文件导入数据`);
                            setToast({ show: true, message: '数据导入成功！', type: 'success' });
                        } else {
                            throw new Error("文件内容格式不正确。");
                        }
                    } catch (error) {
                        setToast({ show: true, message: `导入失败：${error.message}`, type: 'error' });
                    }
                };
                fileReader.onerror = () => setToast({ show: true, message: '读取文件失败！', type: 'error' });
                event.target.value = null;
            };

            return (
                <div className="container mx-auto px-1 sm:px-2 md:px-4 max-w-3xl h-full flex flex-col">
                    {toast.show && <Toast message={toast.message} type={toast.type} onHide={() => setToast({ ...toast, show: false })} />}
                    <header className="text-right mb-2 sm:mb-4 pt-4 sm:pt-6 md:pt-8 flex-shrink-0">
                        <h1 className="text-xs font-normal text-gray-400 flex items-center justify-end">
                            <span className={`w-2.5 h-2.5 rounded-full mr-2 ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></span>
                            Bingo 的 AI 私人助理
                        </h1>
                    </header>
                    
                <nav className="mb-4 flex justify-center bg-gray-200/50 rounded-lg flex-shrink-0">
                    <div className="flex items-center p-1 overflow-x-auto scrollbar-hide whitespace-nowrap">
                        <button onClick={() => setCurrentView('list')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'list' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="记录">
                            <List size={22} />
                        </button>
                        <button onClick={() => setCurrentView('todo')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'todo' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="待办">
                            <ClipboardCheck size={22} />
                        </button>
                        <button onClick={() => setCurrentView('schedule')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'schedule' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="日程">
                            <CalendarIcon size={22} />
                        </button>
                        <button onClick={() => setCurrentView('awaiting')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'awaiting' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="等待">
                            <Users size={22} />
                        </button>
                        <button onClick={() => setCurrentView('projects')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'projects' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="项目">
                            <LayoutGrid size={22} />
                        </button>
                        {/* 修改：将“想法”改为“生活想法” */}
                        <button onClick={() => setCurrentView('ideas')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'ideas' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="生活想法">
                            <Lightbulb size={22} />
                        </button>
                        {/* 新增：“工作记录”按钮 */}
                        <button onClick={() => setCurrentView('work_records')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'work_records' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="工作记录">
                            <NotebookPenIcon size={22} />
                        </button>
                        <button onClick={() => setCurrentView('assistant')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'assistant' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="AI助理">
                            <Bot size={22} />
                        </button>
                        <button onClick={() => setCurrentView('insights')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'insights' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="AI说">
                            <BotMessageSquareIcon size={22} />
                        </button>
                        <button onClick={() => setCurrentView('settings')} className={`p-3 rounded-md transition-colors flex-shrink-0 ${currentView === 'settings' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`} title="设置">
                            <Settings size={22} />
                        </button>
                    </div>
                </nav>

                    <div ref={contentRef} className="flex-grow min-h-0 pb-4 sm:pb-6 md:pb-8">
                        {currentView === 'list' && (
                            <ListView 
                                tasks={tasks} error={error} inputValue={inputValue} setInputValue={setInputValue} isLoading={isLoading} handleAddTask={handleAddTask} editingTask={editingTask} expandedRawTextId={expandedRawTextId} handlers={handlers}
                            />
                        )}
                        {currentView === 'todo' && (
                            <TodoView
                                tasks={tasks}
                                editingTask={editingTask} 
                                expandedRawTextId={expandedRawTextId}
                                handlers={handlers}
                                callArkApi={callArkApi}
                            />
                        )}
                        {currentView === 'schedule' && (
                            <ScheduleView
                                tasks={tasks}
                                editingTask={editingTask} 
                                expandedRawTextId={expandedRawTextId}
                                handlers={handlers}
                                callArkApi={callArkApi}
                            />
                        )}
                        {currentView === 'awaiting' && (
                            <AwaitingView
                                tasks={tasks}
                                handlers={{ openTaskViewModal, sendAtomicUpdate, requestDelete }}
                            />
                        )}
                        {currentView === 'ideas' && (
                            <IdeasView 
                                tasks={tasks.filter(t => t.type === 'idea')} 
                                allTasks={tasks} // 新增：传递所有任务用于检查是否已收藏
                                callArkApi={callArkApi}
                                handleSaveGeneralInsight={handleSaveGeneralInsight} // 新增：传递收藏函数
                                editingTask={editingTask} 
                                expandedRawTextId={expandedRawTextId} 
                                handlers={handlers}
                            />
                        )}
                        {currentView === 'work_records' && (
                            <WorkRecordsView 
                                tasks={tasks.filter(t => t.type === 'work_record')} 
                                allTasks={tasks}
                                callArkApi={callArkApi}
                                handleSaveGeneralInsight={handleSaveGeneralInsight}
                                editingTask={editingTask} 
                                expandedRawTextId={expandedRawTextId} 
                                handlers={handlers}
                            />
                        )}

                        {currentView === 'assistant' && (
                            <AssistantView 
                                allTasks={tasks}
                                callArkApi={callArkApi}
                                handleSaveGeneralInsight={handleSaveGeneralInsight}
                            />
                        )}
                        {currentView === 'insights' && (
                            <InsightsView
                                tasks={tasks}
                                handlers={handlers}
                                formatCreationTime={formatCreationTime}
                                callArkApi={callArkApi}
                            />
                        )}
                        {currentView === 'projects' && (
                            <ProjectsView 
                                tasks={tasks}
                                handlers={handlers}
                                sendAtomicUpdate={sendAtomicUpdate}
                                callArkApi={callArkApi}
                                expandedRawTextId={expandedRawTextId}
                            />
                        )}
                        {currentView === 'settings' && (
                            <SettingsView 
                                handleExportData={handleExportData}
                                handleImportData={handleImportData}
                                workRecordNotebooks={workRecordNotebooks}
                                sendAtomicUpdate={sendAtomicUpdate}
                            />
                        )}
                    </div>

                    {taskToDelete && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl max-w-sm w-full">
                                <h3 className="text-base sm:text-lg font-bold">确认删除</h3>
                                <p className="text-sm text-gray-600 my-4">你确定要删除这个条目吗？此操作无法撤销。</p>
                                <div className="flex justify-end gap-3 sm:gap-4">
                                    <button onClick={cancelDelete} className="px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-red-500 text-white rounded-md hover:bg-red-600">确认删除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {conversionConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl max-w-sm w-full">
                                <h3 className="text-base sm:text-lg font-bold">确认转换</h3>
                                {conversionConfirm.type === 'task' ? (
                                    <div>
                                        <p className="text-sm text-gray-600 my-4">您希望将任务 “{conversionConfirm.title}” 转为哪种类型？<br/><span className="text-xs text-gray-400 mt-1 block">转换后，任务的日期和地点信息将被清除。</span></p>
                                        <div className="flex flex-col gap-3 mt-4">
                                            {/* 新增的按钮 */}
                                            <button onClick={() => confirmConversion(conversionConfirm, 'idea')} className="w-full px-4 py-2.5 text-sm bg-orange-500 text-white rounded-md hover:bg-orange-600">转为生活想法</button>
                                            <button onClick={() => confirmConversion(conversionConfirm, 'work_record')} className="w-full px-4 py-2.5 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600">转为工作记录</button>
                                            <button onClick={() => setConversionConfirm(null)} className="w-full mt-2 px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <p className="text-sm text-gray-600 my-4">您希望如何处理想法 “{conversionConfirm.title}”？</p>
                                        <div className="flex flex-col gap-3">
                                            <button onClick={() => confirmConversion(conversionConfirm, 'todo')} className="w-full px-4 py-2.5 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">转为待办任务</button>
                                            <button onClick={() => confirmConversion(conversionConfirm, 'scheduled')} className="w-full px-4 py-2.5 text-sm bg-green-500 text-white rounded-md hover:bg-green-600">转为今日任务</button>
                                            <button onClick={() => setConversionConfirm(null)} className="w-full mt-2 px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {taskToUncomplete && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl max-w-sm w-full">
                                <h3 className="text-base sm:text-lg font-bold">确认操作</h3>
                                <p className="text-sm text-gray-600 my-4">您确定要将此任务重新标记为“未完成”状态吗？</p>
                                <div className="flex justify-end gap-3 sm:gap-4">
                                    <button onClick={cancelUncomplete} className="px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                                    <button onClick={confirmUncomplete} className="px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">确认</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {nestedInsightToDelete && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl max-w-sm w-full">
                                <h3 className="text-base sm:text-lg font-bold">确认删除</h3>
                                <p className="text-sm text-gray-600 my-4">您确定要删除这条 AI 建议吗？此操作无法撤销。</p>
                                <div className="flex justify-end gap-3 sm:gap-4">
                                    <button onClick={cancelNestedInsightDelete} className="px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                                    <button onClick={confirmNestedInsightDelete} className="px-4 py-2 text-sm bg-red-500 text-white rounded-md hover:bg-red-600">确认删除</button>
                                </div>
                            </div>
                        </div>
                    )}

                {reshapingTask && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl max-w-lg w-full">
                            <h3 className="text-base sm:text-lg font-bold flex items-center gap-2"><Sparkles className="text-purple-500"/>补充与编辑</h3>

                            {/* --- 新增的编辑区 --- */}
                            <div className="my-4 space-y-3 text-sm">
                                <div>
                                    <label className="font-semibold text-gray-600">标题</label>
                                    <input 
                                        type="text"
                                        name="title"
                                        value={reshapingTask.title}
                                        onChange={handleReshapeFieldChange}
                                        className="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-purple-400 focus:outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="font-semibold text-gray-600">原始内容</label>
                                    <textarea 
                                        name="rawText"
                                        value={reshapingTask.rawText}
                                        onChange={handleReshapeFieldChange}
                                        className="w-full mt-1 h-20 p-2 border rounded-md focus:ring-2 focus:ring-purple-400 focus:outline-none"
                                    />
                                </div>
                                <div className="flex items-end gap-4">
                                    {/* 地点输入框（宽度缩短） */}
                                    <div className="flex-grow">
                                        <label className="font-semibold text-gray-600">地点 (可选)</label>
                                        <input 
                                            type="text"
                                            name="location"
                                            value={reshapingTask.location || ''}
                                            onChange={handleReshapeFieldChange}
                                            className="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-purple-400 focus:outline-none"
                                        />
                                    </div>
                                    {/* 新增的复选框 */}
                                    <div className="flex-shrink-0 mb-2">
                                        <label className="flex items-center gap-2 cursor-pointer text-sm">
                                            <input
                                                type="checkbox"
                                                checked={shouldUpdateDateTime}
                                                onChange={() => setShouldUpdateDateTime(prev => !prev)}
                                                className="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                            />
                                            <span className="text-gray-700">智能更新日期</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            {/* --- 补充内容区 --- */}
                            <textarea 
                                autoFocus
                                value={reshapeInputValue} 
                                onChange={(e) => setReshapeInputValue(e.target.value)} 
                                className="w-full h-24 p-2 border border-blue-300 bg-blue-50/50 rounded-md focus:ring-2 focus:ring-purple-400 focus:outline-none text-sm" 
                                placeholder="请在这里输入补充内容，AI 将整合所有信息进行更新..."
                            />

                            {error && <p className="text-red-500 text-xs sm:text-sm mt-2">{error}</p>}

                                <div className="flex justify-between items-center mt-4 pt-4 border-t">
                                    {/* --- 新增的删除按钮（在最左边） --- */}
                                    <button 
                                        onClick={() => { requestDelete(reshapingTask.id); closeReshapeModal(); }}
                                        disabled={isReshaping}
                                        className="px-3 sm:px-4 py-2 text-sm text-red-600 hover:bg-red-100 rounded-md flex items-center gap-2 transition-colors disabled:opacity-50"
                                    >
                                        <Trash2 size={16}/>删除
                                    </button>

                                    {/* --- 右侧的按钮组 --- */}
                                    <div className="flex gap-2 sm:gap-4">
                                        <button 
                                            onClick={closeReshapeModal} 
                                            disabled={isReshaping} 
                                            className="px-3 sm:px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300 disabled:opacity-50"
                                        >
                                            取消
                                        </button>
                                        <button 
                                            onClick={handleReshapeTask} 
                                            disabled={isReshaping} 
                                            className="px-3 sm:px-4 py-2 text-sm bg-purple-500 text-white rounded-md hover:bg-purple-600 disabled:bg-purple-300 flex items-center justify-center w-28 sm:w-32"
                                        >
                                            {isReshaping ? <Loader size={20} /> : '智能更新'}
                                        </button>
                                    </div>
                                </div>
                        </div>
                    </div>
                )}

                    {assistingTask && (
                       <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-2 sm:p-4 pt-10 sm:pt-20">
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh] sm:max-h-[85vh]">
                                <div className="flex-shrink-0 pb-3 border-b">
                                    <h3 className="text-base sm:text-lg font-bold flex items-center gap-2"><Bot className="text-green-500"/>AI 助理</h3>
                                    <p className="text-sm text-gray-600 mt-2">正在分析 “{assistingTask.title}” ...</p>
                                </div>
                                <div ref={assistantChatContainerRef} className="py-4 overflow-y-auto text-sm flex-grow min-h-0 space-y-4">
                                    {assistantMessages.map((msg, index) => {
                                        if (msg.role === 'user') {
                                            return (
                                                <div key={index} className="flex justify-end">
                                                    <div className="max-w-full px-4 py-3 rounded-2xl bg-blue-500 text-white">
                                                        <div className="assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}></div>
                                                    </div>
                                                </div>
                                            );
                                        }

                                        if (msg.role === 'assistant') {
                                            const isAlreadySaved = (assistingTask.savedInsights || []).some(insight => insight.content === msg.content);
                                            return (
                                                <div key={index} className="flex flex-col items-start w-full">
                                                    <div className="w-full max-w-full px-4 py-3 rounded-2xl bg-gray-100 text-gray-800">
                                                        {!msg.content && msg.loading ? (
                                                            <div className="flex items-center gap-2 text-gray-500">
                                                                <Loader size={16} />
                                                                <span>正在思考...</span>
                                                            </div>
                                                        ) : (
                                                            <div className="assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}></div>
                                                        )}
                                                    </div>

                                                    {msg.content && !msg.loading && (
                                                        <div className="w-full flex justify-end mt-2 pr-1">
                                                            <button 
                                                                onClick={() => !isAlreadySaved && handleSaveInsight(assistingTask.id, msg.content)}
                                                                disabled={isAlreadySaved}
                                                                className={`flex items-center gap-1.5 px-3 py-1 text-xs rounded-full transition-colors ${
                                                                    isAlreadySaved 
                                                                    ? 'bg-green-100 text-green-700' 
                                                                    : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                                                }`}
                                                            >
                                                                <Bookmark size={14} className={isAlreadySaved ? "fill-current" : ""}/>
                                                                <span>{isAlreadySaved ? "已收藏" : "收藏此建议"}</span>
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        }
                                        return null;
                                    })}
                                    <div ref={assistantChatEndRef} />
                                    {error && <p className="text-red-500 text-xs sm:text-sm mt-2">{error}</p>}
                                </div>
                                <div className="pt-3 border-t flex-shrink-0 space-y-3">
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="text"
                                            inputMode="text"
                                            value={assistantUserInput}
                                            onChange={(e) => setAssistantUserInput(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleContinueAssistantChat()}
                                            placeholder="继续聊聊这个任务..."
                                            className="flex-grow p-2 text-sm bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
                                        />
                                        <button onClick={handleContinueAssistantChat} disabled={!assistantUserInput.trim()} className="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 disabled:bg-blue-300 flex-shrink-0">
                                            <Send size={20} />
                                        </button>
                                    </div>
                                    <div className="flex justify-center">
                                        <button onClick={closeAssistantModal} className="px-5 py-2 text-sm bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">关闭</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {viewingTask && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300" 
                            onClick={closeTaskViewModal}
                        >
                            <div className="w-full max-w-lg" onClick={(e) => e.stopPropagation()}>
                                <TaskCard
                                    task={viewingTask}
                                    allTasks={tasks}
                                    editingTask={editingTask}
                                    expandedRawTextId={expandedRawTextId}
                                    handlers={handlers}
                                    onTagClick={() => {}} 
                                    onEnergyClick={() => {}} 
                                    onEnvironmentClick={() => {}}
                                    onCategoryClick={() => {}}
                                />
                            </div>
                        </div>
                    )}
                    {assigningProjectTask && (
                        <ProjectAssignerModal
                            task={assigningProjectTask}
                            projects={tasks.filter(t => t.type === 'project')}
                            onAssign={handleAssignTaskToProject}
                            onRemove={handleRemoveTaskFromProject}
                            onClose={handleCloseProjectAssigner}
                        />
                    )}
                    {viewingInsight && (
                        <InsightViewModal
                            insight={viewingInsight}
                            onClose={() => setViewingInsight(null)}
                            formatCreationTime={formatCreationTime}
                        />
                    )}
                    {viewingInsight && (
                        <InsightViewModal
                            insight={viewingInsight}
                            onClose={() => setViewingInsight(null)}
                            formatCreationTime={formatCreationTime}
                        />
                    )}
                    {/* --- 在这里添加下面的代码 --- */}
                    {schedulingTask && (
                        <CalendarModal
                            task={schedulingTask}
                            onConfirm={handleScheduleTask}
                            onClose={() => setSchedulingTask(null)}
                            onClear={handleClearSchedule}
                        />
                    )}
                    {creatingFollowUpForTask && (
                        <FollowUpModal
                            parentTask={creatingFollowUpForTask}
                            callArkApi={callArkApi}
                            onSave={handleSaveFollowUp}
                            onClose={() => setCreatingFollowUpForTask(null)}
                        />
                    )}
                    {/* --- START: 渲染笔记本编辑器弹窗 --- */}
                    {editingNotebooksTask && (
                        <NotebookEditorModal
                            task={editingNotebooksTask}
                            allNotebooks={workRecordNotebooks}
                            onSave={handleSaveNotebooks}
                            onClose={() => setEditingNotebooksTask(null)}
                        />
                    )}
                    {/* --- END: 渲染结束 --- */}
        </div>
    );
}

        function FollowUpModal({ parentTask, callArkApi, onSave, onClose }) {
            const [rawInput, setRawInput] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [error, setError] = useState('');

            // --- 修改 #1: State现在同时管理日期和时间 ---
            const [followUpData, setFollowUpData] = useState({
                assignee: '',
                title: '',
                dueDate: '',
                dueTime: '' // 新增时间 state
            });

            const handleAnalyze = async () => {
                if (!rawInput.trim()) return;
                setIsAnalyzing(true);
                setError('');
                
                // --- 修改 #2: 更新AI指令，要求返回精确时间 ---
                const prompt = `你是一个专门解析“跟进任务”的AI助手。请从用户的自然语言输入中，严格提取以下三个信息，并只返回一个JSON对象：
        - "assignee" (string): 任务的负责人或等待的对象。
        - "title" (string): 具体需要跟进或等待完成的核心事项。
        - "dueDate" (string): 要求的截止日期和时间，格式必须为 "YYYY-MM-DD HH:mm:ss"。

        请遵循以下时间解析规则：
        - "今天下午3点" -> 解析为今天的 "15:00:00"。
        - "明天上午" -> 解析为明天的 "09:00:00"。
        - "后天" -> 解析为后天的 "00:00:00"。
        - 如果只提供了日期但没有具体时间（如“明天开会”），则时间部分应设为 "00:00:00"。
        - 如果缺少任何信息，对应字段的值应为 null。

        - 今天的日期是: ${new Date().toLocaleDateString('sv')}
        - 用户输入是: "${rawInput}"
        - 这条跟进项所属的主任务是: "${parentTask.title}"

        请只返回JSON对象本身，不要包含任何额外的解释或代码块标记。`;

                try {
                    const result = await callArkApi(prompt);
                    // --- 修改 #3: 解析AI返回的完整日期时间 ---
                    let datePart = '';
                    let timePart = '';
                    if (result.dueDate && result.dueDate.includes(' ')) {
                        const parts = result.dueDate.split(' ');
                        datePart = parts[0];
                        // 只取 HH:mm 部分
                        timePart = parts[1] ? parts[1].substring(0, 5) : ''; 
                    } else {
                        datePart = result.dueDate || '';
                    }

                    setFollowUpData({
                        assignee: result.assignee || '',
                        title: result.title || '',
                        dueDate: datePart,
                        dueTime: timePart
                    });
                } catch (err) {
                    console.error("AI解析跟进项失败:", err);
                    setError("AI解析失败，请手动填写。");
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const handleFieldChange = (e) => {
                const { name, value } = e.target;
                setFollowUpData(prev => ({ ...prev, [name]: value }));
            };

            const handleSave = () => {
                if (!followUpData.title || !followUpData.assignee || !followUpData.dueDate) {
                    setError("负责人、事项和截止日期均为必填项。");
                    return;
                }
                
                // --- 修改 #4: 保存时拼接日期和时间 ---
                const finalDueDate = `${followUpData.dueDate} ${followUpData.dueTime || '00:00'}:00`;

                const newFollowUp = {
                    id: `fu_${Date.now()}_${Math.random()}`,
                    parentId: parentTask.id,
                    type: 'follow_up',
                    rawText: rawInput,
                    assignee: followUpData.assignee,
                    title: followUpData.title,
                    dueDate: finalDueDate,
                    isCompleted: false,
                    createdAt: new Date().toISOString(),
                };

                onSave(newFollowUp);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white p-5 rounded-xl shadow-xl w-full max-w-lg" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">为任务添加跟进项</h3>
                        <p className="text-sm text-gray-500 mb-4 truncate">主任务: {parentTask.title}</p>

                        <div className="relative">
                            <textarea
                                autoFocus
                                value={rawInput}
                                onChange={(e) => setRawInput(e.target.value)}
                                className="w-full h-24 p-2 border border-blue-300 bg-blue-50/50 rounded-md focus:ring-2 focus:ring-purple-400 focus:outline-none text-sm"
                                placeholder="例如：等张三今天下午3点给我发第一版资料..."
                            />
                            <button
                                onClick={handleAnalyze}
                                disabled={isAnalyzing || !rawInput.trim()}
                                className="absolute bottom-2 right-2 px-3 py-1 text-xs bg-purple-500 text-white rounded-md hover:bg-purple-600 disabled:bg-purple-300 flex items-center"
                            >
                                {isAnalyzing ? <Loader size={16} className="mr-1" /> : <Sparkles size={14} className="mr-1" />}
                                AI 解析
                            </button>
                        </div>

                        <div className="mt-4 space-y-3">
                            <div>
                                <label className="text-sm font-medium text-gray-700">等待谁 (Assignee)</label>
                                <input type="text" name="assignee" value={followUpData.assignee} onChange={handleFieldChange} className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
                            </div>
                            <div>
                                <label className="text-sm font-medium text-gray-700">什么事 (Item)</label>
                                <input type="text" name="title" value={followUpData.title} onChange={handleFieldChange} className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
                            </div>
                            {/* --- 修改 #5: 将单个日期输入框拆分为日期和时间 --- */}
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-sm font-medium text-gray-700">截止日期</label>
                                    <input type="date" name="dueDate" value={followUpData.dueDate} onChange={handleFieldChange} className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-gray-700">截止时间 (可选)</label>
                                    <input type="time" name="dueTime" value={followUpData.dueTime} onChange={handleFieldChange} className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
                                </div>
                            </div>
                        </div>

                        {error && <p className="text-red-500 text-xs mt-3">{error}</p>}

                        <div className="flex justify-end gap-3 mt-5 pt-4 border-t">
                            <button onClick={onClose} className="px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                            <button onClick={handleSave} className="px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600">保存跟进项</button>
                        </div>
                    </div>
                </div>
            );
        }

        function InsightViewModal({ insight, onClose, formatCreationTime }) {
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-2 sm:p-4 transition-opacity duration-300" 
                    onClick={onClose}
                >
                    <div 
                        className="bg-white p-5 sm:p-6 rounded-xl shadow-xl w-full max-w-4xl flex flex-col max-h-[90vh] sm:max-h-[85vh]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex-shrink-0 pb-3 border-b mb-4">
                            <h3 className="text-base sm:text-lg font-bold flex items-center gap-2"><BotMessageSquareIcon className="text-blue-500"/>AI 洞察详情</h3>
                            <p className="text-xs text-gray-400 mt-1">保存于 {formatCreationTime(insight.createdAt)}</p>
                        </div>
                        <div className="overflow-y-auto flex-grow min-h-0 assistant-output"
                             dangerouslySetInnerHTML={{ __html: marked.parse(insight.content) }}>
                        </div>
                         <div className="pt-4 mt-4 border-t flex-shrink-0 flex justify-center">
                            <button onClick={onClose} className="px-6 py-2 text-sm bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">关闭</button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function TaskCard({ task, allTasks, editingTask, expandedRawTextId, handlers, onTagClick, onEnergyClick, onEnvironmentClick, onCategoryClick, onFilterClick }) {
            const { startEditing, cancelEditing, saveEditing, handleEditChange, requestConversion, handleToggleCompletion, toggleRawText, openReshapeModal, requestDelete, handleGetAssistance, getTagColor, formatDateRange, formatCreationTime, handleDeleteInsight, handleViewFullInsight, openCalendarScheduler, openFollowUpModal, openNotebookEditor } = handlers;
            const [isTitleExpanded, setIsTitleExpanded] = useState(false);
            const [isLocationExpanded, setIsLocationExpanded] = useState(false);
            const [datePart, timePart] = editingTask && editingTask.startDate ? editingTask.startDate.split(' ') : ['', ''];
            const hasSpecificTimeInRaw = editingTask && /[0-9](:|：|点)|(上|下|中)午|凌晨|晚上|am|pm/i.test(editingTask.rawText);
            const isMidnight = timePart === '00:00:00';
            const displayTime = isMidnight && !hasSpecificTimeInRaw ? '' : (timePart || '').substring(0, 5);
            // --- 用下面的代码，完整替换掉旧的 formatFollowUpDate 函数 ---
            // --- 用这个最终版本，完整替换掉旧的 formatFollowUpDate 函数 ---
            const formatFollowUpDate = (dateString, isCompleted) => {
                if (isCompleted) {
                    return (
                        <span className="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">
                            已完成
                        </span>
                    );
                }
                if (!dateString) return null;

                const date = new Date(dateString.replace(/-/g, '/'));
                const now = new Date();
                // 只取日期的年月日部分进行比较
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                const tomorrowStart = new Date(todayStart);
                tomorrowStart.setDate(tomorrowStart.getDate() + 1);
                
                // --- 新增代码：计算“后天”的开始日期 ---
                const dayAfterTomorrowStart = new Date(tomorrowStart);
                dayAfterTomorrowStart.setDate(dayAfterTomorrowStart.getDate() + 1);

                // --- 新增代码：计算“大后天”的开始日期，用于判断“后天”的范围 ---
                const dayAfterDayAfterTomorrowStart = new Date(dayAfterTomorrowStart);
                dayAfterDayAfterTomorrowStart.setDate(dayAfterDayAfterTomorrowStart.getDate() + 1);

                const isOverdue = !isCompleted && date < now;
                const isToday = date >= todayStart && date < tomorrowStart;
                const isTomorrow = date >= tomorrowStart && date < dayAfterTomorrowStart;
                // --- 新增代码：判断是否为“后天” ---
                const isDayAfterTomorrow = date >= dayAfterTomorrowStart && date < dayAfterDayAfterTomorrowStart;
                
                let styleClasses = 'bg-gray-100 text-gray-600'; 
                if (isOverdue) {
                    styleClasses = 'bg-red-100 text-red-700';
                } else if (isToday) {
                    styleClasses = 'bg-blue-100 text-blue-700';
                }

                let dateText;
                if (isOverdue) {
                    dateText = '已逾期';
                } else if (isToday) {
                    dateText = '今天';
                } else if (isTomorrow) {
                    dateText = '明天';
                } 
                // --- 新增代码：增加对“后天”的判断 ---
                else if (isDayAfterTomorrow) {
                    dateText = '后天';
                } 
                else {
                    dateText = `${date.getMonth() + 1}/${date.getDate()}`;
                }
                
                const timeText = (date.getHours() === 0 && date.getMinutes() === 0) 
                    ? '' 
                    : ` ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                return (
                    <span className={`px-2 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${styleClasses}`}>
                        {`${dateText}${timeText}`}
                    </span>
                );
            };
            const context = (editingTask && editingTask.context) || task.context;
            const isNewContext = typeof context === 'object' && context !== null;
            
            const isRawTextExpanded = expandedRawTextId === task.id;
            const hasSavedInsights = task.savedInsights && task.savedInsights.length > 0;

            const stripMarkdown = (md) => {
                if (!md) return '';
                return md.replace(/!?\[.*?\]\(.*?\)/g, '').replace(/`{1,3}[\s\S]*?`{1,3}/g, '').replace(/[#*_~>|`]/g, '').replace(/\s{2,}/g, ' ').trim();
            };
            const extractBoldedText = (markdown) => {
                if (!markdown) return '';
                const boldRegex = /\*\*(.*?)\*\*/g;
                const matches = [...markdown.matchAll(boldRegex)];

                if (matches.length > 0) {
                    return matches.map(match => match[1].trim()).join(' ... ');
                } else {
                    return stripMarkdown(markdown);
                }
            };

            const followUpItems = useMemo(() => {
                if (!allTasks) return [];
                return allTasks
                    .filter(item => item.type === 'follow_up' && item.parentId === task.id)
                    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)); // 按创建时间排序
            }, [allTasks, task.id]);
            
            const hasFollowUps = followUpItems.length > 0;
            const uncompletedFollowUps = followUpItems.filter(item => !item.isCompleted).length;


            return (
                <div 
                    className={`bg-white rounded-xl shadow-md p-4 sm:p-5 transition-all duration-500 ${task.isCompleted && task.type === 'task' ? 'opacity-50' : ''} ${task.isNew ? 'ring-2 ring-green-400 bg-green-50' : ''}`}
                >
                    {editingTask && editingTask.id === task.id ? (
                        <div className="space-y-4">
                            {/* 编辑模式代码 (无变化) */}
                            <input type="text" name="title" value={editingTask.title} onChange={handleEditChange} className="w-full p-2 text-base sm:text-lg font-medium border rounded-md" placeholder="标题"/>
                            
                            {editingTask.type === 'task' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="date" name="startDate_date" value={datePart} onChange={handleEditChange} className="w-full p-2 border rounded-md text-sm" title="开始日期"/>
                                    <input type="time" name="startDate_time" value={displayTime} onChange={handleEditChange} className="w-full p-2 border rounded-md text-sm" title="开始时间 (可选)"/>
                                    <input type="text" name="location" value={editingTask.location || ''} onChange={handleEditChange} placeholder="地点" className="w-full p-2 border rounded-md text-sm"/>
                                </div>
                            )}

                            <input type="text" name="tags" value={(editingTask.tags || []).join(', ')} onChange={handleEditChange} placeholder="普通标签 (用逗号分隔)" className="w-full p-2 border rounded-md text-sm"/>
                            {editingTask.type === 'work_record' && (
                                <input 
                                    type="text" 
                                    name="notebooks" 
                                    value={(editingTask.notebooks || []).join(', ')} 
                                    onChange={handleEditChange} 
                                    placeholder="笔记本分类 (用逗号分隔)" 
                                    className="w-full p-2 border border-indigo-300 bg-indigo-50/50 rounded-md text-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                                />
                            )}
                            <div className="flex justify-end gap-3 mt-4 pt-4 border-t">
                                <button 
                                    onClick={() => requestDelete(editingTask.id)} 
                                    className="px-4 py-2 text-sm text-red-600 hover:bg-red-100 rounded-md flex items-center gap-2 transition-colors">
                                    <Trash2 size={16}/>删除
                                </button>
                                <button onClick={cancelEditing} className="px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300 flex items-center gap-2"><XCircleIcon size={16}/>取消</button>
                                <button onClick={saveEditing} className="px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center gap-2"><Save size={16}/>保存</button>
                            </div>
                        </div>
                    ) : (
                        <div>
                            <div className="flex items-start gap-3 sm:gap-4">
                                <div className="flex-shrink-0 flex flex-col items-center pt-1">
                                    <div className="h-6 w-6 flex items-center justify-center mb-2">
                                        {/* --- 这里是第一个修改点 --- */}
                                        {task.type === 'task' ? (
                                            <input type="checkbox" checked={task.isCompleted} onChange={() => handleToggleCompletion(task)} className="h-5 w-5 sm:h-6 sm:w-6 rounded border-gray-300 text-blue-500 focus:ring-blue-500 cursor-pointer"/>
                                        ) : task.type === 'idea' ? (
                                            <Lightbulb className="w-5 h-5 sm:w-6 sm:w-6 text-orange-400" />
                                        ) : task.type === 'follow_up' ? (
                                            <Users className="w-5 h-5 sm:w-6 sm:w-6 text-teal-500" />
                                        ) : ( // 默认是 work_record
                                            <NotebookPenIcon className="w-5 h-5 sm:w-6 sm:w-6 text-indigo-500" />
                                        )}
                                    </div>
                                    <div className="flex flex-col">
                                        {/* --- 这里是第二个修改点 --- */}
                                        {task.type === 'task' ? (
                                            <button onClick={() => requestConversion(task)} className="text-gray-400 hover:text-orange-500 transition-colors p-1" title="转为想法"><Repeat size={16} /></button>
                                        ) : (task.type === 'idea' || task.type === 'work_record') ? (
                                            <button onClick={() => requestConversion(task)} className="text-gray-400 hover:text-blue-500 transition-colors p-1" title="转为任务"><Repeat size={16} /></button>
                                        ) : null}
                                    </div>
                                </div>

                                <div className="flex-grow min-w-0">
                                    {/* ... 中间内容无变化 ... */}
                                    <p 
                                        className={`text-base sm:text-lg font-medium text-gray-800 cursor-pointer ${!isTitleExpanded ? 'truncate' : 'whitespace-normal'}`}
                                        onClick={() => setIsTitleExpanded(!isTitleExpanded)}
                                        title="点击展开/折叠标题"
                                    >
                                        {task.title}
                                    </p>
                                    
                                    <div className="mt-1">
                                        <p className={`text-xs sm:text-sm text-gray-400 raw-text-expandable ${isRawTextExpanded ? 'whitespace-normal' : 'truncate'}`} onClick={() => {
                                            if (window.getSelection().toString().length === 0) {
                                                toggleRawText(task.id);
                                            }
                                        }}>
                                            原始记录: {task.rawText}
                                        </p>
                                        {isRawTextExpanded && (
                                            <div className="mt-3 space-y-3">
                                                <button onClick={() => openReshapeModal(task)} className="flex items-center gap-1.5 px-2 py-1 text-xs text-purple-700 bg-purple-50 hover:bg-purple-100 rounded-md transition-colors">
                                                    <Sparkles size={14}/>
                                                    <span>编辑/补充</span>
                                                </button>
                                                {hasSavedInsights && (
                                                     <div className="p-3 bg-gray-50 rounded-lg">
                                                        <h4 className="text-xs font-semibold text-gray-700 mb-2 flex items-center gap-1.5"><BotMessageSquareIcon size={14} className="text-blue-500"/>AI 洞察 ({task.savedInsights.length})</h4>
                                                        <div className="space-y-2">
                                                            {task.savedInsights.map(insight => (
                                                                <div
                                                                    key={insight.id}
                                                                    onClick={() => handleViewFullInsight(insight)}
                                                                    className="p-2.5 bg-white hover:bg-blue-50 border border-gray-200 rounded-lg cursor-pointer group transition-colors"
                                                                >
                                                                    <p className="text-sm text-gray-700 line-clamp-2">
                                                                        {extractBoldedText(insight.content)}
                                                                    </p>
                                                                    <div className="flex justify-between items-center mt-2 pt-1 border-t border-gray-100">
                                                                        <span className="text-xs text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity font-medium">查看详情...</span>
                                                                        <button onClick={(e) => { e.stopPropagation(); handleDeleteInsight(task.id, insight.id); }} className="text-gray-400 hover:text-red-500" title="删除此条洞察">
                                                                            <Trash2 size={14}/>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex flex-wrap items-center gap-x-3 sm:gap-x-4 gap-y-2 text-gray-600 mt-3 text-xs sm:text-sm">
                                        {isTodoTask(task) ? (
                                            <button onClick={() => openCalendarScheduler(task)} className="flex items-center gap-1.5 text-gray-600 hover:text-blue-600 transition-colors p-1 -m-1 rounded-md group">
                                                <CalendarIcon className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-gray-400 group-hover:text-blue-500" />
                                                <span>待安排</span>
                                            </button>
                                        ) : (
                                            task.startDate && (
                                                <button 
                                                    onClick={() => openCalendarScheduler(task)} 
                                                    className="flex items-center gap-1.5 text-gray-600 hover:text-blue-600 transition-colors p-1 -m-1 rounded-md group"
                                                >
                                                    <CalendarIcon className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-500 group-hover:text-blue-500 transition-colors" />
                                                    <span>{formatDateRange(task.startDate, task.endDate, task.rawText)}</span>
                                                </button>
                                            )
                                        )}
                                        {task.type !== 'task' && !isTodoTask(task) && (<div className="flex items-center gap-1.5"><CalendarIcon className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-gray-400" /><span>记录于 {formatCreationTime(task.createdAt)}</span></div>)}
                                        {task.location && (<div className="flex items-center gap-1.5 cursor-pointer min-w-0" onClick={() => setIsLocationExpanded(!isLocationExpanded)}><MapPin className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-red-500" /><span className={`${isLocationExpanded ? '' : 'truncate'} flex-grow min-w-0`}>{task.location}</span></div>)}
                                    </div>
                                </div>
                                <div className="flex flex-col sm:flex-row gap-1">
                                    <button onClick={() => handlers.handleOpenProjectAssigner(task)} className="text-gray-400 hover:text-indigo-500 transition-colors p-1" title="归入项目"><LayoutGrid size={18} /></button>
                                    <button onClick={() => handlers.openFollowUpModal(task)} className="text-gray-400 hover:text-teal-500 transition-colors p-1" title="添加跟进项"><Users size={18} /></button>
                                </div>
                            </div>
                            <div className="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center gap-2">
                                {/* ... 底部标签区域无变化 ... */}
                                <div className="flex items-center gap-2 flex-grow min-w-0">
                                    {/* --- START: 这是我们修改的核心 --- */}
                                    {task.type === 'work_record' ? (
                                        <button onClick={(e) => { e.stopPropagation(); openNotebookEditor(task); }} className="text-gray-400 hover:text-indigo-500 transition-colors flex-shrink-0" title="编辑笔记本分类">
                                            <Tag className="w-3.5 h-3.5" />
                                        </button>
                                    ) : (
                                        <Tag className="w-3.5 h-3.5 text-gray-400 flex-shrink-0" />
                                    )}
                                    {/* --- END: 修改结束 --- */}

                                    <div className="overflow-x-auto scrollbar-hide whitespace-nowrap">
                                        <div className="flex items-center gap-2">
                                            {hasSavedInsights && (
                                                <span className="p-1 rounded-full bg-blue-100 text-blue-800" title="包含 AI 洞察">
                                                    <BotMessageSquareIcon size={14}/>
                                                </span>
                                            )}
                                            {task.projectId && (
                                                <span className="p-1 rounded-full bg-indigo-100 text-indigo-800" title="已归入项目">
                                                    <LayoutGrid size={14}/>
                                                </span>
                                            )}
                                            {task.type === 'task' && isNewContext && (
                                                <>
                                                    {context.taskType && (
                                                        <span
                                                            onClick={() => onEnergyClick && onEnergyClick(context.taskType)}
                                                            className="px-2 py-0.5 text-xs font-medium rounded-full bg-purple-100 text-purple-800 cursor-pointer hover:opacity-80">
                                                            {context.taskType}
                                                        </span>
                                                    )}
                                                    {context.locationScene && (
                                                        <span
                                                            onClick={() => onEnvironmentClick && onEnvironmentClick(context.locationScene)}
                                                            className="px-2 py-0.5 text-xs font-medium rounded-full bg-sky-100 text-sky-800 cursor-pointer hover:opacity-80">
                                                            {context.locationScene}
                                                        </span>
                                                    )}
                                                    {context.category && (
                                                        <span
                                                            onClick={() => onCategoryClick && onCategoryClick(context.category)}
                                                            className={`px-2 py-0.5 text-xs font-medium rounded-full ${context.category === '工作' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'} cursor-pointer hover:opacity-80`}>
                                                            {context.category}
                                                        </span>
                                                    )}
                                                </>
                                            )}
                                            
                                            {/* --- START: 最终版标签显示逻辑 --- */}
                                            {task.type === 'work_record' ? (
                                                task.notebooks && task.notebooks.map(notebook => (
                                                    <span 
                                                        key={notebook} 
                                                        onClick={(e) => { e.stopPropagation(); onFilterClick && onFilterClick(notebook); }}
                                                        className="px-2 py-0.5 text-xs font-medium rounded-full bg-indigo-100 text-indigo-800 cursor-pointer hover:opacity-80"
                                                    >
                                                        {notebook}
                                                    </span>
                                                ))
                                            ) : (
                                                task.tags && task.tags.map(tag => (
                                                    <span 
                                                        key={tag} 
                                                        onClick={(e) => { e.stopPropagation(); onFilterClick && onFilterClick(tag); }}
                                                        className={`px-2 py-0.5 text-xs font-medium rounded-full ${getTagColor(tag)} cursor-pointer hover:opacity-80`}
                                                    >
                                                        {tag}
                                                    </span>
                                                ))
                                            )}
                                            {/* --- END: 最终逻辑结束 --- */}
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => handleGetAssistance(task)} className="text-gray-400 hover:text-green-500 transition-colors p-1 flex items-center gap-1 text-xs sm:text-sm flex-shrink-0" title="AI建议">
                                    <Bot size={14} />
                                    <span>AI建议</span>
                                </button>
                            </div>

                            {hasFollowUps && (
                                <div className="mt-4 pt-3 border-t border-gray-100">
                                    <h4 className="text-xs font-semibold text-gray-600 mb-2 flex items-center gap-1.5">
                                        <Users size={14} className="text-teal-500" />
                                        跟进项 ({uncompletedFollowUps} / {followUpItems.length} 未完成)
                                    </h4>
                                    <ul className="space-y-1.5 text-sm">
                                        {followUpItems.map(item => (
                                            <li key={item.id} className="flex items-center justify-between text-gray-700">
                                                <div className="flex items-center gap-2 min-w-0">
                                                    <input type="checkbox" checked={item.isCompleted} readOnly className="h-4 w-4 rounded-sm border-gray-300 flex-shrink-0" />
                                                    <span className={`truncate ${item.isCompleted ? 'line-through text-gray-400' : ''}`} title={`${item.title} (${item.assignee})`}>
                                                        {item.title} ({item.assignee})
                                                    </span>
                                                </div>
                                                <span className="text-xs font-medium flex-shrink-0 ml-2">
                                                    {formatFollowUpDate(item.dueDate, item.isCompleted)}
                                                </span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function InsightCard({ insight, onViewDetail, onViewSource, onDelete, formatCreationTime }) {
            
            const extractSummary = (markdown) => {
                if (!markdown) return '无内容';
                const boldRegex = /\*\*(.*?)\*\*/g;
                const matches = [...markdown.matchAll(boldRegex)];

                if (matches.length > 0) {
                    return matches.map(match => match[1].trim()).join(' ... ');
                }
                
                const plainText = markdown
                    .replace(/!?\[.*?\]\(.*?\)/g, '')
                    .replace(/`{1,3}[\s\S]*?`{1,3}/g, '')
                    .replace(/[#*_~>|`]/g, '')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
                return plainText;
            };

            const sourceTypeText = {
                'assistant': 'AI 助理',
                'task': '任务',
                'idea': '想法',
                'project': '项目',
            };
            
            const isSourceClickable = !!insight.sourceId;

            return (
                <div 
                    onClick={onViewDetail}
                    className={`bg-white rounded-xl shadow-md p-4 sm:p-5 transition-all duration-300 ${insight.isNew ? 'ring-2 ring-green-400 bg-green-50' : ''} cursor-pointer hover:bg-gray-50`}
                >
                    <div className="flex items-start gap-4">
                        <div className="flex-shrink-0 flex flex-col items-center gap-y-3 pt-1">
                            <div className="text-blue-500">
                                <BotMessageSquareIcon size={24} />
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="text-gray-400 hover:text-red-500 transition-colors p-1" title="删除">
                                <Trash2 size={18} />
                            </button>
                        </div>
                        <div className="flex-grow min-w-0">
                            <p className="text-gray-800 text-sm line-clamp-2">
                                {extractSummary(insight.content)}
                            </p>
                            
                            <div className="mt-3 text-xs text-gray-500 flex min-w-0">
                                {insight.sourceType === 'assistant' && insight.userPrompt ? (
                                    <>
                                        <span className="flex-shrink-0">我的提问:&nbsp;</span>
                                        <span className="font-semibold text-gray-600 truncate" title={insight.userPrompt}>
                                            {insight.userPrompt}
                                        </span>
                                    </>
                                ) : (
                                    <>
                                        <span className="flex-shrink-0">来自 {sourceTypeText[insight.sourceType] || '未知'}:&nbsp;</span>
                                        {isSourceClickable ? (
                                            <span
                                                onClick={(e) => { e.stopPropagation(); onViewSource(); }}
                                                className="font-semibold text-blue-600 hover:underline cursor-pointer truncate"
                                                title={insight.sourceTitle}
                                            >
                                                {insight.sourceTitle}
                                            </span>
                                        ) : (
                                            <span className="font-semibold text-gray-600 truncate" title={insight.sourceTitle}>{insight.sourceTitle}</span>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="mt-4 pt-3 border-t border-gray-100 flex justify-end items-center text-xs text-gray-400">
                        <span>保存于 {formatCreationTime(insight.createdAt)}</span>
                    </div>
                </div>
            );
        }

        function IdeaChatModal({ isOpen, onClose, ideas, activeFilter, allTasks, callArkApi, handleSaveGeneralInsight, ideaType = 'life' }) {
            const initialMessage = { role: 'assistant', content: '你好！我已经看完了你所有的想法记录。关于这些灵感，你想聊点什么？' };
            const [messages, setMessages] = useState([initialMessage]);
            const [userInput, setUserInput] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const [showPresetPrompts, setShowPresetPrompts] = useState(true);
            const chatContainerRef = useRef(null);
            const chatEndRef = useRef(null);
            const abortControllerRef = useRef(null);
            
            // 为“工作想法”定制的专业预设问题
            const workPresetPrompts = [
                "综合分析我所有的工作记录，反复出现的核心问题是什么？请归纳成3点。",
                "请将所有关于“XX工艺”的记录，整理成一份SOP（标准作业程序）的初稿。",
                "根据我的记录，识别出当前生产流程中最大的3个瓶颈或风险点。",
                "有哪些记录可以提炼成给新员工的培训材料？"
            ];

            // 原有的“生活想法”预设问题
            const lifePresetPrompts = [
                "在我记录的这些想法中，反复出现的核心主题是什么？",
                "有哪些想法之间存在潜在的联系，可以组合成一个更大的计划？",
                "综合分析我的所有想法，它们反映出我当前最关心或最焦虑的是什么？"
            ];

            // 根据 ideaType 决定使用哪一套预设问题
            const presetPrompts = ideaType === 'work' ? workPresetPrompts : lifePresetPrompts;


            useEffect(() => {
                if (!isOpen) return;
                const container = chatContainerRef.current;
                if (!container) return;
                const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 100;
                if (isScrolledToBottom) {
                    // --- 这里是本次的修改 ---
                    chatEndRef.current?.scrollIntoView({ block: 'end' });
                    // --- 修改结束 ---
                }
            }, [messages, isOpen]);
            
            const handleNewChat = () => {
                if (isThinking) {
                    abortControllerRef.current?.abort();
                    setIsThinking(false);
                }
                setMessages([initialMessage]);
                setShowPresetPrompts(true);
            };

            const callApiForResponse = async (history) => {
                setIsThinking(true);
                abortControllerRef.current = new AbortController();

                const workSystemPrompt = `你是一位经验丰富的工作流程分析专家和管理顾问。你的核心任务是深入分析我提供给你的‘工作记录’资料库，这些是我在日常工作中记录的关于流程、管理、生产、工艺等方面的具体问题和知识点。请帮我从中提炼出可行动的洞察和改进建议。

                    **你的核心工作是：**
                    1.  **识别模式与根本原因**：找出记录中反复出现的问题模式，并尝试分析其背后的根本原因（例如：是沟通不畅、是流程缺失，还是技能不足？）。
                    2.  **整合与归纳**：将零散的记录整合成系统性的知识，或归纳成特定主题（如“xx产品的质量问题”、“新员工培训要点”）。
                    3.  **提出优化方案**：基于记录中的问题，提出具体、可行的改进建议或行动计划。
                    4.  **发现潜在风险**：从记录中识别出可能被忽视的潜在风险或流程瓶颈。

                    **沟通要求：**
                    * **严格基于资料**：你的分析必须围绕我提供的记录展开，不要凭空捏造。
                    * **专业、务实、直指问题核心**：回答要一针见血，能直接用于解决工作问题，不要有任何客套话。
                    * **结构化输出**：请使用 Markdown 的要点和列表来组织你的发现，使其清晰易读。

                    ${activeFilter ? `\n# 当前筛选上下文\n用户已经筛选了“${activeFilter}”这个分类，所以下面的所有资料都与此相关。请将你的分析聚焦在这个主题上。\n` : ''}

                    这是你需要分析的资料：
                    ---
                    [工作记录资料]
                    ${JSON.stringify(ideas)}
                    ---
                    现在，请根据用户的提问和我给你的资料，开始分析。`;

                    // 原有的“生活想法”系统指令
                    const lifeSystemPrompt = `你是一位敏锐的思维教练和创意分析师。你的任务是深入分析我提供给你的‘想法空间’资料库，这些都是我平时记录的零散想法和灵感。请帮我梳理和链接它们。

                    **你的核心工作是：**
                    1.  **识别核心主题**：找出反复出现的想法、概念或我关心的领域 (例如: ‘个人成长’, ‘项目管理’, ‘人际关系’)。
                    2.  **建立意外链接**：发现不同想法之间的潜在联系或组合可能性，即使它们表面上看起来无关。
                    3.  **洞察底层逻辑**：分析这些想法背后可能反映出的、我当前的思维模式、价值观或关注焦点是什么。

                    **沟通要求：**
                    * **严格基于资料**：你的分析必须围绕我提供的想法记录展开，不要创造新内容。
                    * **启发性与简洁**：回答要像朋友一样，一针见血，能启发思考，不要有任何客套话。
                    * **结构化输出**：请使用 Markdown 的要点和列表来组织你的发现，使其清晰易读。

                    这是你需要分析的资料：
                    ---
                    [想法空间资料]
                    ${JSON.stringify(ideas)}
                    ---
                    现在，请根据用户的提问和我给你的资料，开始分析。`;

                    // 根据 ideaType 决定使用哪一套系统指令
                    const systemPrompt = ideaType === 'work' ? workSystemPrompt : lifeSystemPrompt;
                
                const apiMessages = [{ role: "system", content: systemPrompt }, ...history];

                try {
                    setMessages(prev => [...prev, { role: 'assistant', content: '' }]);
                    const reader = await callArkApi({ messages: apiMessages, stream: true }, true, abortControllerRef.current.signal);
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.substring(6);
                                if (jsonStr.trim() === '[DONE]') break;
                                try {
                                    const parsed = JSON.parse(jsonStr);
                                    if (parsed.choices && parsed.choices[0].delta.content) {
                                        const contentChunk = parsed.choices[0].delta.content;
                                        setMessages(prev => {
                                            const newMessages = [...prev];
                                            newMessages[newMessages.length - 1].content += contentChunk;
                                            return newMessages;
                                        });
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        const errorMsg = '抱歉，我好像有点走神了，请稍后再试。';
                        setMessages(prev => {
                            const newMessages = [...prev];
                            if (newMessages[newMessages.length - 1].content === '') {
                                newMessages[newMessages.length - 1].content = errorMsg;
                                return newMessages;
                            }
                            return [...prev, { role: 'assistant', content: errorMsg }];
                        });
                    }
                } finally {
                    setIsThinking(false);
                    abortControllerRef.current = null;
                }
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!userInput.trim() || isThinking) return;
                
                setShowPresetPrompts(false);
                const newUserMessage = { role: 'user', content: userInput };
                const currentHistory = [...messages, newUserMessage];
                setMessages(currentHistory);
                setUserInput('');
                await callApiForResponse(currentHistory);
            };

            const handlePresetClick = async (prompt) => {
                if (isThinking) return;
                setShowPresetPrompts(false);
                const newUserMessage = { role: 'user', content: prompt };
                const currentHistory = [...messages, newUserMessage];
                setMessages(currentHistory);
                await callApiForResponse(currentHistory);
            };
            
            const handleStop = () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-2 sm:p-4 pt-10 sm:pt-20" onClick={onClose}>
                    <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col h-[90vh] sm:h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="flex-shrink-0 pb-3 border-b flex justify-between items-center">
                            <div>
                                <h3 className="text-base sm:text-lg font-bold flex items-center gap-2"><SproutIcon className="text-green-500"/>智慧再发芽</h3>
                                {/* --- START: 修改部分 --- */}
                                <p className="text-sm text-gray-500 mt-2">
                                    {ideaType === 'work' && activeFilter 
                                        ? `深入分析“${activeFilter}”分类下的 ${ideas.length} 条记录...`
                                        : (ideaType === 'work' ? '分析你的工作记录，挖掘改进机会' : '深入你的想法，发现内在联系')
                                    }
                                </p>
                            </div>
                            <button onClick={handleNewChat} title="开启新对话" className="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors">
                                <RefreshCw size={18} />
                            </button>
                        </div>
                        <div ref={chatContainerRef} className="py-4 overflow-y-auto text-sm flex-grow min-h-0 space-y-4">
                            {messages.map((msg, index) => {
                                if (msg.role === 'user') {
                                    return (
                                        <div key={index} className="flex justify-end">
                                            <div className="max-w-full px-4 py-3 rounded-2xl bg-blue-500 text-white assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}></div>
                                        </div>
                                    );
                                }
                                if (msg.role === 'assistant' && msg.content) {
                                    const isSaved = allTasks.some(t => t.type === 'insight' && t.content === msg.content);
                                    return (
                                        <div key={index} className="flex flex-col items-start w-full">
                                            <div className="w-full max-w-full">
                                                <div className="px-4 py-3 rounded-2xl bg-gray-100 text-gray-800">
                                                    {(isThinking && index === messages.length - 1 && !msg.content) ? (
                                                        <div className="flex items-center gap-2 text-gray-500">
                                                            <Loader size={16} />
                                                            <span>正在思考...</span>
                                                        </div>
                                                    ) : (
                                                        <div className="assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content || '') }}></div>
                                                    )}
                                                </div>
                                                {/* --- 新增的收藏按钮逻辑 --- */}
                                                {!isThinking && msg.content && msg.content !== initialMessage.content && (
                                                    <div className="w-full flex justify-end mt-2 pr-1">
                                                        <button 
                                                            onClick={() => {
                                                                const lastUserMsg = [...messages].slice(0, index).reverse().find(m => m.role === 'user');
                                                                handleSaveGeneralInsight(msg.content, lastUserMsg ? lastUserMsg.content : '来自想法空间的提问');
                                                            }}
                                                            disabled={isSaved}
                                                            className={`flex items-center gap-1.5 px-3 py-1 text-xs rounded-full transition-colors ${
                                                                isSaved 
                                                                ? 'bg-green-100 text-green-700' 
                                                                : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                                            }`}
                                                        >
                                                            <Bookmark size={14} className={isSaved ? "fill-current" : ""}/>
                                                            <span>{isSaved ? "已收藏" : "收藏"}</span>
                                                        </button>
                                                    </div>
                                                )}
                                                {/* --- 新增逻辑结束 --- */}
                                            </div>
                                        </div>
                                    );
                                }
                                return null;
                            })}

                            {showPresetPrompts && (
                                <div className="pt-2 space-y-2">
                                    {presetPrompts.map((prompt, index) => (
                                        <button
                                            key={index}
                                            onClick={() => handlePresetClick(prompt)}
                                            className="w-full text-left p-3 bg-gray-50 hover:bg-gray-200 rounded-lg text-sm text-gray-700 transition-colors"
                                        >
                                            {prompt}
                                        </button>
                                    ))}
                                </div>
                            )}

                            <div ref={chatEndRef} />
                        </div>
                        <div className="pt-3 border-t flex-shrink-0 space-y-3">
                            <form onSubmit={handleSendMessage} className="flex items-center gap-2">
                                <input
                                    type="text" inputMode="text" value={userInput}
                                    onChange={(e) => setUserInput(e.target.value)}
                                    placeholder="关于这些想法，我想问..."
                                    className="flex-grow p-2 text-sm bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition"
                                    disabled={isThinking}
                                />
                                {isThinking ? (
                                    <button type="button" onClick={handleStop} className="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 flex-shrink-0"><Square size={20} /></button>
                                ) : (
                                    <button type="submit" disabled={!userInput.trim()} className="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 disabled:bg-green-300 flex-shrink-0"><Send size={20} /></button>
                                )}
                            </form>
                            <div className="flex justify-center">
                                <button onClick={onClose} className="px-5 py-2 text-sm bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }



        function InsightChatModal({ isOpen, onClose, insights, callArkApi }) {
            const initialMessage = { role: 'assistant', content: '你好，朋友。你收藏的这些智慧我都看过了。关于这些，你想聊点什么？' };
            const [messages, setMessages] = useState([initialMessage]);
            const [userInput, setUserInput] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const [showPresetPrompts, setShowPresetPrompts] = useState(true);
            const chatContainerRef = useRef(null);
            const chatEndRef = useRef(null);
            const abortControllerRef = useRef(null);
            
            const presetPrompts = [
                "在我收藏的这些亮点中，反复出现的核心主题是什么？",
                "有哪些看似无关，但底层逻辑相通的建议？",
                "综合来看，我可能忽略了什么思维盲区或最该优先行动的是什么？"
            ];

            useEffect(() => {
                if (!isOpen) return;

                const container = chatContainerRef.current;
                if (!container) return;

                // 检查用户是否在底部
                const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 100;

                // 只有当用户在底部时，才自动进行瞬间滚动
                if (isScrolledToBottom) {
                    chatEndRef.current?.scrollIntoView({ block: 'end' });
                }
            }, [messages, isOpen]);
            
            const handleNewChat = () => {
                if (isThinking) {
                    abortControllerRef.current?.abort();
                    setIsThinking(false);
                }
                setMessages([initialMessage]);
                setShowPresetPrompts(true);
            };

            const callApiForResponse = async (history) => {
                setIsThinking(true);
                abortControllerRef.current = new AbortController();

                const systemPrompt = `你是一个思想整合分析师，也是一个敏锐的朋友和咨询师。你的唯一任务是深入分析我提供给你的‘AI亮点回顾’资料库，并从中提炼洞察。

                **你的核心工作是：**
                1.  **识别反复出现的主题**：找出资料中频繁出现的关键概念，如‘沟通’、‘精力管理’等。
                2.  **揭示内在联系**：找出不同亮点之间的深层逻辑联系，即使它们表面上来自不同领域（如工作与生活）。
                3.  **发现盲区与矛盾**：指出这些亮点中可能存在的潜在矛盾、冲突或被我忽略的思维盲区。

                **沟通要求：**
                * **严格基于资料**：绝对不要创造任何资料库之外的新建议。
                * **直接且简洁**：回答必须简单明了，一针见血，不要有任何客套话。
                * **结构化输出**：请使用 Markdown 的要点和列表来组织你的发现，使其清晰易读。

                这是你需要分析的资料：
                ---
                [AI亮点回顾资料]
                ${JSON.stringify(insights)}
                ---
                现在，请根据用户的提问和我给你的资料，开始分析。`;
                
                const apiMessages = [{ role: "system", content: systemPrompt }, ...history];

                try {
                    setMessages(prev => [...prev, { role: 'assistant', content: '' }]);
                    const reader = await callArkApi({ messages: apiMessages, stream: true }, true, abortControllerRef.current.signal);
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.substring(6);
                                if (jsonStr.trim() === '[DONE]') break;
                                try {
                                    const parsed = JSON.parse(jsonStr);
                                    if (parsed.choices && parsed.choices[0].delta.content) {
                                        const contentChunk = parsed.choices[0].delta.content;
                                        setMessages(prev => {
                                            const newMessages = [...prev];
                                            newMessages[newMessages.length - 1].content += contentChunk;
                                            return newMessages;
                                        });
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        const errorMsg = '抱歉，我好像有点走神了，请稍后再试。';
                         setMessages(prev => {
                            const newMessages = [...prev];
                            if (newMessages[newMessages.length - 1].content === '') {
                                newMessages[newMessages.length - 1].content = errorMsg;
                                return newMessages;
                            }
                            return [...prev, { role: 'assistant', content: errorMsg }];
                        });
                    }
                } finally {
                    setIsThinking(false);
                    abortControllerRef.current = null;
                }
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!userInput.trim() || isThinking) return;
                
                setShowPresetPrompts(false);
                const newUserMessage = { role: 'user', content: userInput };
                const currentHistory = [...messages, newUserMessage];
                setMessages(currentHistory);
                setUserInput('');
                await callApiForResponse(currentHistory);
            };

            const handlePresetClick = async (prompt) => {
                if (isThinking) return;
                setShowPresetPrompts(false);
                const newUserMessage = { role: 'user', content: prompt };
                const currentHistory = [...messages, newUserMessage];
                setMessages(currentHistory);
                await callApiForResponse(currentHistory);
            };
            
            const handleStop = () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }
            };

            if (!isOpen) return null;

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start z-50 p-2 sm:p-4 pt-10 sm:pt-20" onClick={onClose}>
                    <div className="bg-white p-4 sm:p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col h-[90vh] sm:h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="flex-shrink-0 pb-3 border-b flex justify-between items-center">
                            <div>
                                <h3 className="text-base sm:text-lg font-bold flex items-center gap-2"><SproutIcon className="text-green-500"/>智慧再发芽</h3>
                                <p className="text-sm text-gray-500 mt-2">整合你的 AI 亮点，启发新洞见</p>
                            </div>
                            <button onClick={handleNewChat} title="开启新对话" className="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors">
                                <RefreshCw size={18} />
                            </button>
                        </div>
                        <div ref={chatContainerRef} className="py-4 overflow-y-auto text-sm flex-grow min-h-0 space-y-4">
                            {messages.map((msg, index) => (
                                msg.role === 'user' ? (
                                    <div key={index} className="flex justify-end">
                                        <div className="max-w-full px-4 py-3 rounded-2xl bg-blue-500 text-white assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}></div>
                                    </div>
                                ) : (
                                    <div key={index} className="flex justify-start">
                                        <div className="max-w-full px-4 py-3 rounded-2xl bg-gray-100 text-gray-800">
                                        {(isThinking && index === messages.length - 1 && !msg.content) ? (
                                            <div className="flex items-center gap-2 text-gray-500">
                                                <Loader size={16} />
                                                <span>正在思考...</span>
                                            </div>
                                        ) : (
                                            <div className="assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content || '') }}></div>
                                        )}
                                        </div>
                                    </div>
                                )
                            ))}

                            {showPresetPrompts && (
                                <div className="pt-2 space-y-2">
                                    {presetPrompts.map((prompt, index) => (
                                        <button
                                            key={index}
                                            onClick={() => handlePresetClick(prompt)}
                                            className="w-full text-left p-3 bg-gray-50 hover:bg-gray-200 rounded-lg text-sm text-gray-700 transition-colors"
                                        >
                                            {prompt}
                                        </button>
                                    ))}
                                </div>
                            )}

                            <div ref={chatEndRef} />
                        </div>
                        <div className="pt-3 border-t flex-shrink-0 space-y-3">
                            <form onSubmit={handleSendMessage} className="flex items-center gap-2">
                                <input
                                    type="text" inputMode="text" value={userInput}
                                    onChange={(e) => setUserInput(e.target.value)}
                                    placeholder="关于这些亮点，我想问..."
                                    className="flex-grow p-2 text-sm bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition"
                                    disabled={isThinking}
                                />
                                {isThinking ? (
                                     <button type="button" onClick={handleStop} className="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 flex-shrink-0"><Square size={20} /></button>
                                ) : (
                                     <button type="submit" disabled={!userInput.trim()} className="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 disabled:bg-green-300 flex-shrink-0"><Send size={20} /></button>
                                )}
                            </form>
                            <div className="flex justify-center">
                                <button onClick={onClose} className="px-5 py-2 text-sm bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        function InsightsView({ tasks, handlers, formatCreationTime, callArkApi }) {
            const { handleUnifiedDeleteInsight, openTaskViewModal, handleViewFullInsight } = handlers;
            const [searchQuery, setSearchQuery] = useState('');
            const [isSearching, setIsSearching] = useState(false);
            const [searchResultIds, setSearchResultIds] = useState(null);
            const [error, setError] = useState('');
            const [isInsightChatOpen, setIsInsightChatOpen] = useState(false);

            const allDisplayableInsights = useMemo(() => {
                const insights = [];

                tasks.forEach(task => {
                    if (task.type === 'insight') {
                        insights.push({
                            id: task.id,
                            content: task.content,
                            createdAt: task.createdAt,
                            sourceType: 'assistant',
                            sourceTitle: 'AI 助理',
                            userPrompt: task.rawText,
                            sourceId: null,
                            isNew: task.isNew,
                        });
                    }
                    else if (task.savedInsights && task.savedInsights.length > 0) {
                        task.savedInsights.forEach(savedInsight => {
                            insights.push({
                                id: savedInsight.id,
                                content: savedInsight.content,
                                createdAt: savedInsight.savedAt,
                                sourceType: task.type,
                                sourceTitle: task.title,
                                sourceId: task.id,
                                isNew: false,
                            });
                        });
                    }
                });
                
                return insights.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }, [tasks]);
            
            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                setIsSearching(true);
                setSearchResultIds(null);
                setError('');

                const searchableInsights = allDisplayableInsights.map(i => ({ id: i.id, content: i.content, sourceTitle: i.sourceTitle }));

                const prompt = `你是一位经验丰富的个人知识管理专家和AI助理。你的任务是深入理解用户的自然语言查询，从下面的AI洞察列表中，找出所有与查询主题、概念或情境相关的条目。请重点分析'content'和'sourceTitle'字段。\n- 用户请求: '${searchQuery}'\n- AI洞察列表 (JSON): ${JSON.stringify(searchableInsights)}\n请严格只返回一个包含所有匹配项ID的JSON数组 (e.g., ["insight_1724936400000_0.5", "insight_1724936500000_0.8"])。不要返回任何其他解释。如果找不到任何匹配项，请返回一个空数组 []。`;

                try {
                    const matchingIds = await callArkApi(prompt);
                    if (Array.isArray(matchingIds)) {
                        setSearchResultIds(matchingIds);
                    } else {
                        throw new Error("AI返回了意料之外的格式。");
                    }
                } catch (err) {
                    console.error("AI洞察搜索错误:", err);
                    setError(err.message || "无法连接到AI服务。");
                    setSearchResultIds([]);
                } finally {
                    setIsSearching(false);
                }
            };

            const clearSearch = () => {
                setSearchQuery('');
                setSearchResultIds(null);
                setError('');
            };

            const insightsToDisplay = searchResultIds !== null
                ? allDisplayableInsights.filter(insight => searchResultIds.includes(insight.id))
                : allDisplayableInsights;

            const handleViewSourceClick = (sourceId) => {
                if (!sourceId) return;
                const sourceTask = tasks.find(t => t.id === sourceId);
                if (sourceTask) {
                    openTaskViewModal(sourceTask);
                }
            };

            return (
                <div className="h-full overflow-y-auto scrollbar-hide">
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                        <h2 className="text-xl sm:text-2xl font-semibold text-gray-700">AI 亮点回顾</h2>
                        <p className="text-sm text-gray-500 mt-1 mb-4">这里是你从各处收藏的所有 AI 建议和洞察。</p>
                        <div className="relative flex items-center gap-2 sm:gap-3">
                            <input type="text" inputMode="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isSearching && handleSearch()} placeholder="用自然语言搜索相关亮点..." className="flex-grow p-3 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" disabled={isSearching}/>
                            <button onClick={handleSearch} disabled={isSearching || !searchQuery.trim()} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">{isSearching ? <Loader /> : <Search />}</button>
                            <button onClick={() => setIsInsightChatOpen(true)} title="智慧再发芽" className="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition-all duration-200 ease-in-out flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">
                                <SproutIcon />
                            </button>
                        </div>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    <main className="space-y-4 px-1">
                         {searchResultIds !== null && (
                            <div className="flex flex-wrap items-center gap-4 mb-4 px-2">
                                <span className="text-sm text-gray-500 flex-shrink-0">筛选:</span>
                                <div className="flex items-center gap-2">
                                    <span className="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 flex items-center gap-1.5"><Search size={14}/> 搜索: "{searchQuery}"</span>
                                    <button onClick={clearSearch} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button>
                                </div>
                            </div>
                        )}

                        {isSearching ? (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md">
                                <div className="flex justify-center items-center text-gray-500">
                                    <Loader className="mr-3" />
                                    <span>AI正在检索亮点...</span>
                                </div>
                            </div>
                        ) : insightsToDisplay.length > 0 ? (
                            insightsToDisplay.map(insight => 
                                <InsightCard 
                                    key={insight.id}
                                    insight={insight}
                                    onViewDetail={() => handleViewFullInsight(insight)}
                                    onViewSource={() => handleViewSourceClick(insight.sourceId)}
                                    onDelete={() => handleUnifiedDeleteInsight(insight)}
                                    formatCreationTime={formatCreationTime}
                                />
                            )
                        ) : (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md">
                                <p className="text-gray-500">
                                    {searchResultIds !== null ? '根据你的描述，没有找到相关的亮点。' : '还没有任何收藏的亮点。'}
                                </p>
                                <p className="text-sm text-gray-400 mt-2">
                                    {searchResultIds === null && '在和 AI 助理对话或查看卡片建议时，点击“收藏”按钮来收集吧！'}
                                </p>
                            </div>
                        )}
                    </main>
                    <InsightChatModal
                        isOpen={isInsightChatOpen}
                        onClose={() => setIsInsightChatOpen(false)}
                        insights={allDisplayableInsights}
                        callArkApi={callArkApi}
                    />
                </div>
            );
        }

        function ProjectAssignerModal({ task, projects, onAssign, onRemove, onClose }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white p-4 sm:p-5 rounded-xl shadow-xl w-full max-w-sm flex flex-col" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-base sm:text-lg font-bold text-gray-800 text-center mb-1 flex-shrink-0">项目归类</h3>
                        <p className="text-sm text-gray-500 text-center mb-4 truncate flex-shrink-0">正在操作: {task.title}</p>
                        
                        <div className="flex-grow min-h-0 overflow-y-auto space-y-1 max-h-[60vh]">
                            {projects.map(project => {
                                const isCurrentProject = task.projectId === project.id;
                                
                                return (
                                    <button
                                        key={project.id}
                                        onClick={() => onAssign(task.id, project.id)}
                                        className={`w-full flex items-center justify-between text-left px-3 py-2.5 rounded-lg transition-colors duration-200 ${
                                            isCurrentProject 
                                            ? 'bg-blue-500 text-white font-semibold' 
                                            : 'bg-gray-100 hover:bg-blue-100 hover:text-blue-700'
                                        }`}
                                    >
                                        <span className="truncate pr-2">{project.title}</span>
                                        {isCurrentProject && <Check size={20} />}
                                    </button>
                                );
                            })}
                            {projects.length === 0 && <p className="text-center text-gray-400 py-4">还没有创建任何项目</p>}
                        </div>

                        <div className="mt-4 pt-4 border-t border-gray-200 space-y-2 flex-shrink-0">
                            {task.projectId && (
                                <button
                                    onClick={() => onRemove(task.id)}
                                    className="w-full text-left px-3 py-2.5 bg-red-50 hover:bg-red-100 text-red-700 rounded-lg transition-colors duration-200"
                                >
                                    从项目中移除
                                </button>
                            )}
                            <button
                                onClick={onClose}
                                className="w-full text-left px-3 py-2.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200"
                            >
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function ListView({ tasks, error, inputValue, setInputValue, isLoading, handleAddTask, ...props }) {
            const mattersCount = tasks.filter(t => t.type === 'task').length;
            const ideasCount = tasks.filter(t => t.type === 'idea').length;
            const workRecordsCount = tasks.filter(t => t.type === 'work_record').length;
            const [selectedTag, setSelectedTag] = useState(null);
            const [selectedTaskType, setSelectedTaskType] = useState(null);
            const [selectedLocationScene, setSelectedLocationScene] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [visibleCount, setVisibleCount] = useState(15);
            const scrollContainerRef = useRef(null);
            const prevTasksLength = useRef(tasks.length);

            useEffect(() => {
                if (tasks.length > prevTasksLength.current && scrollContainerRef.current) {
                    scrollContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
                prevTasksLength.current = tasks.length;
            }, [tasks]);

            const filteredTasks = useMemo(() => {
                return tasks.filter(task => {
                    // --- 这里是本次修改的核心 ---
                    // 过滤掉项目、AI洞察，以及我们新增的“跟进项”
                    if (task.type === 'project' || task.type === 'insight' || task.type === 'follow_up') return false;
                    
                    const tagMatch = selectedTag ? task.tags && task.tags.includes(selectedTag) : true;
                    const context = task.context;
                    const isNewContext = typeof context === 'object' && context !== null;
                    const taskTypeMatch = selectedTaskType ? isNewContext && context.taskType === selectedTaskType : true;
                    const locationSceneMatch = selectedLocationScene ? isNewContext && context.locationScene === selectedLocationScene : true;
                    const categoryMatch = selectedCategory ? isNewContext && context.category === selectedCategory : true;
                    return tagMatch && taskTypeMatch && locationSceneMatch && categoryMatch;
                });
            }, [tasks, selectedTag, selectedTaskType, selectedLocationScene, selectedCategory]);

            const sortedTasks = useMemo(() => sortByCreatedAt(filteredTasks), [filteredTasks]);
            
            const visibleTasks = sortedTasks.slice(0, visibleCount);

            return (
                    <div className="h-full overflow-y-auto scrollbar-hide" ref={scrollContainerRef}>
                        <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                            <div className="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 mb-4">
                                <h2 className="text-xl sm:text-2xl font-semibold text-gray-700">随时记录</h2>
                                <div className="flex items-center gap-2 text-sm text-gray-500">
                                    <span>已记录</span>
                                    <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                        {mattersCount}个事项
                                    </span>
                                    <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                                        {ideasCount}个想法
                                    </span>
                                    <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">
                                        {workRecordsCount}个记录
                                    </span>
                                </div>
                            </div>
                        <div className="relative flex items-center gap-2 sm:gap-3">
                            <input type="text" inputMode="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isLoading && handleAddTask()} placeholder="输入一个任务或想法..." className="flex-grow p-3 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" disabled={isLoading}/>
                            {inputValue && (
                                <button onClick={() => setInputValue('')} className="absolute right-16 sm:right-20 text-gray-400 hover:text-gray-600 p-2 rounded-full transition-colors">
                                    <XCircleIcon size={20} />
                                </button>
                            )}
                            <button onClick={handleAddTask} disabled={isLoading} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">{isLoading ? <Loader /> : <Plus />}</button>
                        </div>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>
                    <main>
                         {(selectedTag || selectedTaskType || selectedLocationScene || selectedCategory) && (
                            <div className="flex flex-wrap items-center gap-4 mb-4 px-2">
                                <span className="text-sm text-gray-500 flex-shrink-0">筛选:</span>
                                 {selectedTag && (
                                     <div className="flex items-center gap-2">
                                         <span className={`px-2 py-1 text-xs font-medium rounded-full ${props.handlers.getTagColor(selectedTag)}`}>{selectedTag}</span>
                                         <button onClick={() => setSelectedTag(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button>
                                     </div>
                                 )}
                                 {selectedTaskType && (
                                     <div className="flex items-center gap-2">
                                         <span className="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800 flex items-center gap-1.5"><Target size={14}/> {selectedTaskType}</span>
                                         <button onClick={() => setSelectedTaskType(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button>
                                     </div>
                                 )}
                                 {selectedLocationScene && (
                                     <div className="flex items-center gap-2">
                                         <span className="px-2 py-1 text-xs font-medium rounded-full bg-sky-100 text-sky-800 flex items-center gap-1.5"><Layers size={14}/> {selectedLocationScene}</span>
                                         <button onClick={() => setSelectedLocationScene(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button>
                                     </div>
                                 )}
                                 {selectedCategory && (
                                     <div className="flex items-center gap-2">
                                         <span className={`px-2 py-1 text-xs font-medium rounded-full ${selectedCategory === '工作' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>{selectedCategory}</span>
                                         <button onClick={() => setSelectedCategory(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button>
                                     </div>
                                 )}
                            </div>
                         )}

                        <div className="space-y-4 px-1">
                            {visibleTasks.map(task => 
                                <TaskCard 
                                    key={task.id} 
                                    task={task} 
                                    {...props} 
                                    allTasks={tasks} 
                                    onTagClick={setSelectedTag} 
                                    onEnergyClick={setSelectedTaskType} 
                                    onEnvironmentClick={setSelectedLocationScene}
                                    onCategoryClick={setSelectedCategory}
                                />
                            )}
                            {tasks.length === 0 && (<div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><p className="text-gray-500">还没有任何条目，快来添加一个吧！</p></div>)}
                            {tasks.length > 0 && filteredTasks.length === 0 && (<div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><p className="text-gray-500">没有找到匹配筛选条件的条目。</p></div>)}
                        </div>
                        {sortedTasks.length > visibleCount && (
                            <div className="mt-6 text-center">
                                <button onClick={() => setVisibleCount(prev => prev + 15)} className="px-6 py-2 text-sm font-medium text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 transition-colors">
                                    查看更多
                                </button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        function TodoView({ tasks, callArkApi, ...props }) {
            const { handlers } = props;
            const [selectedTag, setSelectedTag] = useState(null);
            const [selectedTaskType, setSelectedTaskType] = useState(null);
            const [selectedLocationScene, setSelectedLocationScene] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [isSearching, setIsSearching] = useState(false);
            const [searchResultIds, setSearchResultIds] = useState(null);
            const [error, setError] = useState('');
            const [visibleCount, setVisibleCount] = useState(20);

            const todoTasks = useMemo(() => {
                const filtered = tasks.filter(task => isTodoTask(task));
                return sortTasks(filtered);
            }, [tasks]);
            const uncompletedCount = todoTasks.filter(task => !task.isCompleted).length;
            const completedCount = todoTasks.filter(task => task.isCompleted).length;

            const filteredTasks = useMemo(() => {
                return todoTasks.filter(task => {
                    const tagMatch = selectedTag ? task.tags && task.tags.includes(selectedTag) : true;
                    const context = task.context;
                    const isNewContext = typeof context === 'object' && context !== null;
                    const taskTypeMatch = selectedTaskType ? isNewContext && context.taskType === selectedTaskType : true;
                    const locationSceneMatch = selectedLocationScene ? isNewContext && context.locationScene === selectedLocationScene : true;
                    const categoryMatch = selectedCategory ? isNewContext && context.category === selectedCategory : true;
                    return tagMatch && taskTypeMatch && locationSceneMatch && categoryMatch;
                });
            }, [todoTasks, selectedTag, selectedTaskType, selectedLocationScene, selectedCategory]);

            const tasksToDisplay = searchResultIds !== null 
            ? todoTasks.filter(task => searchResultIds.includes(task.id)) 
            : filteredTasks;
            const visibleTasks = tasksToDisplay.slice(0, visibleCount);

            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                setIsSearching(true);
                setSearchResultIds(null);
                setError('');
                setSelectedTag(null);
                setSelectedTaskType(null);
                setSelectedLocationScene(null);
                setSelectedCategory(null);
                
                const prompt = `你是一个智能任务筛选助手。请根据用户的自然语言请求，从下面的待办任务列表中找出所有语义上匹配的条目。请重点分析任务的'title'和'rawText'字段。- 用户请求: '${searchQuery}' - 待办任务列表 (JSON): ${JSON.stringify(todoTasks.map(({isNew, ...rest}) => rest))} 请严格只返回一个包含所有匹配项ID的JSON数组 (e.g., [2, 8])。不要返回任何其他解释。如果找不到任何匹配项，请返回一个空数组 []。`;
                try {
                    const matchingIds = await callArkApi(prompt);
                    if (Array.isArray(matchingIds)) {
                        setSearchResultIds(matchingIds);
                    } else { throw new Error("AI返回了意料之外的格式。"); }
                } catch (err) {
                    console.error("待办事项AI查询错误:", err);
                    setError(err.message || "无法连接到AI服务。");
                    setSearchResultIds([]);
                } finally { setIsSearching(false); }
            };

            const clearSearch = () => { setSearchQuery(''); setSearchResultIds(null); setError(''); };
            const handleTagClick = (tag) => { setSelectedTag(tag); clearSearch(); };
            const handleTaskTypeClick = (type) => { setSelectedTaskType(type); clearSearch(); };
            const handleLocationSceneClick = (env) => { setSelectedLocationScene(env); clearSearch(); };
            const handleCategoryClick = (cat) => { setSelectedCategory(cat); clearSearch(); };


            return (
                <div className="h-full overflow-y-auto scrollbar-hide">
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                        <div className="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 mb-4">
                            <h2 className="text-xl sm:text-2xl font-semibold text-gray-700">待办事项</h2>
                            <div className="flex items-center gap-3">
                                <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                    还有 {uncompletedCount}个未安排
                                </span>
                            </div>
                        </div>
                        <div className="relative flex items-center gap-2 sm:gap-3">
                            <input type="text" inputMode="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isSearching && handleSearch()} placeholder="用自然语言搜索你的任务..." className="flex-grow p-3 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" disabled={isSearching}/>
                            <button onClick={handleSearch} disabled={isSearching || !searchQuery.trim()} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">{isSearching ? <Loader /> : <Search />}</button>
                        </div>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>
                    <main className="space-y-4 px-1">
                        {(selectedTag || selectedTaskType || selectedLocationScene || selectedCategory || searchResultIds !== null) && (
                            <div className="flex flex-wrap items-center gap-4 mb-4 px-2">
                                <span className="text-sm text-gray-500 flex-shrink-0">筛选:</span>
                                {searchResultIds !== null && (
                                    <div className="flex items-center gap-2">
                                        <span className="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 flex items-center gap-1.5"><Search size={14}/> 搜索: "{searchQuery}"</span>
                                        <button onClick={clearSearch} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button>
                                    </div>
                                )}
                                {selectedTag && ( <div className="flex items-center gap-2"><span className={`px-2 py-1 text-xs font-medium rounded-full ${handlers.getTagColor(selectedTag)}`}>{selectedTag}</span><button onClick={() => setSelectedTag(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button></div> )}
                                {selectedTaskType && ( <div className="flex items-center gap-2"><span className="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800 flex items-center gap-1.5"><Target size={14}/> {selectedTaskType}</span><button onClick={() => setSelectedTaskType(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button></div> )}
                                {selectedLocationScene && ( <div className="flex items-center gap-2"><span className="px-2 py-1 text-xs font-medium rounded-full bg-sky-100 text-sky-800 flex items-center gap-1.5"><Layers size={14}/> {selectedLocationScene}</span><button onClick={() => setSelectedLocationScene(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button></div> )}
                                {selectedCategory && ( <div className="flex items-center gap-2"> <span className={`px-2 py-1 text-xs font-medium rounded-full ${selectedCategory === '工作' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>{selectedCategory}</span> <button onClick={() => setSelectedCategory(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button> </div> )}
                            </div>
                        )}
                        {isSearching ? (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><div className="flex justify-center items-center text-gray-500"><Loader className="mr-3" /><span>AI正在检索任务...</span></div></div>
                            ) : visibleTasks.length > 0 ? (
                                visibleTasks.map(task => 
                                <TaskCard 
                                    key={task.id} 
                                    task={task} 
                                    {...props} 
                                    allTasks={tasks}
                                    onTagClick={handleTagClick} 
                                    onEnergyClick={handleTaskTypeClick} 
                                    onEnvironmentClick={handleLocationSceneClick} 
                                    onCategoryClick={handleCategoryClick}
                                />)
                        ) : (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><p className="text-gray-500">{searchResultIds !== null ? '根据你的描述，没有找到相关的待办事项。' : '没有需要处理的待办事项。'}</p></div>
                        )}
                        {tasksToDisplay.length > visibleCount && (
                            <div className="mt-6 text-center">
                                <button onClick={() => setVisibleCount(prev => prev + 20)} className="px-6 py-2 text-sm font-medium text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 transition-colors">
                                    查看更多
                                </button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        
// --- 请用下面的代码完整替换旧的 ScheduleView 函数 ---
        function ScheduleView({ tasks, callArkApi, ...props }) {
            const { handlers } = props;
            const [searchQuery, setSearchQuery] = useState('');
            const [isSearching, setIsSearching] = useState(false);
            const [searchResultIds, setSearchResultIds] = useState(null);
            const [error, setError] = useState('');
            
            // 1. 新增：管理当前激活的筛选器，默认为“今天”
            const [activeFilter, setActiveFilter] = useState('today');

            // 2. 核心逻辑：计算日期范围和各个筛选器的任务数量
            const { 
                todayIncompleteCount,
                tomorrowCount,
                next10DaysCount,
                next30DaysCount,
                filteredAndSortedTasks 
            } = useMemo(() => {
                const scheduledTasks = tasks.filter(task => task.type === 'task' && !isTodoTask(task));

                // 定义日期常量
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const todayEnd = new Date(todayStart);
                todayEnd.setDate(todayEnd.getDate() + 1);

                const tomorrowStart = new Date(todayEnd);
                const tomorrowEnd = new Date(tomorrowStart);
                tomorrowEnd.setDate(tomorrowEnd.getDate() + 1);

                const dayAfterTomorrowStart = new Date(tomorrowEnd);

                const next10DaysEnd = new Date(dayAfterTomorrowStart);
                next10DaysEnd.setDate(next10DaysEnd.getDate() + 10);

                const next30DaysEnd = new Date(dayAfterTomorrowStart);
                next30DaysEnd.setDate(next30DaysEnd.getDate() + 30);

                // 定义一个纯按时间排序的函数
                const sortChronologically = (taskArray) => {
                    return [...taskArray].sort((a, b) => {
                        const aDate = new Date(a.startDate.replace(/-/g, '/'));
                        const bDate = new Date(b.startDate.replace(/-/g, '/'));
                        return aDate - bDate;
                    });
                };

                // 计算各个筛选器的数量
                let todayTasks = [];
                let tomorrowTasks = [];
                let next10DaysTasks = [];
                let next30DaysTasks = [];

                scheduledTasks.forEach(task => {
                    const taskDate = new Date(task.startDate.replace(/-/g, '/'));

                    // --- START: 这是我们修改的核心 ---
                    // 1. 判断任务是否已过期且未完成
                    const isOverdueAndIncomplete = taskDate < todayStart && !task.isCompleted;
                    // 2. 判断任务是否是今天到期
                    const isScheduledForToday = taskDate >= todayStart && taskDate < todayEnd;

                    // 如果 任务是今天的 或者 已过期未完成，就都算作“今天”要处理的
                    if (isScheduledForToday || isOverdueAndIncomplete) {
                        todayTasks.push(task);
                    // --- END: 修改结束 ---

                    } else if (taskDate >= tomorrowStart && taskDate < tomorrowEnd) {
                        tomorrowTasks.push(task);
                    } else if (taskDate >= dayAfterTomorrowStart && taskDate < next10DaysEnd) {
                        next10DaysTasks.push(task);
                    } else if (taskDate >= dayAfterTomorrowStart && taskDate < next30DaysEnd) {
                        next30DaysTasks.push(task);
                    }
                });
                
                const todayIncompleteCount = todayTasks.filter(t => !t.isCompleted).length;
                const tomorrowCount = tomorrowTasks.length;
                const next10DaysCount = next10DaysTasks.length;
                const next30DaysCount = next30DaysTasks.length;

                // 根据 activeFilter 准备要显示的任务列表
                let finalTasks;
                switch (activeFilter) {
                    case 'today':
                        // 今天：未完成的在前
                        finalTasks = sortTasks(todayTasks);
                        break;
                    case 'tomorrow':
                        // 明天：按时间顺序
                        finalTasks = sortChronologically(tomorrowTasks);
                        break;
                    case 'next10days':
                        // 10天：按时间顺序
                        finalTasks = sortChronologically(next10DaysTasks);
                        break;
                    case 'next30days':
                        // 30天：按时间顺序
                        finalTasks = sortChronologically(next30DaysTasks);
                        break;
                    case 'all':
                    default:
                        // 所有：按时间顺序
                        finalTasks = sortTasks(scheduledTasks); // sortTasks 默认就是按时间排未完成的
                        break;
                }

                return { 
                    todayIncompleteCount, 
                    tomorrowCount, 
                    next10DaysCount,
                    next30DaysCount,
                    filteredAndSortedTasks: finalTasks 
                };
            }, [tasks, activeFilter]);

            // 搜索功能 (保持不变)
            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                setIsSearching(true);
                setSearchResultIds(null);
                setError('');
                
                const prompt = `你是一个智能任务筛选助手。请根据用户的自然语言请求，从下面的日程任务列表中找出所有语义上匹配的条目。请重点分析任务的'title'和'rawText'字段。- 用户请求: '${searchQuery}' - 日程任务列表 (JSON): ${JSON.stringify(tasks.filter(t => t.type ==='task' && !isTodoTask(t)).map(({isNew, ...rest}) => rest))} 请严格只返回一个包含所有匹配项ID的JSON数组 (e.g., [2, 8])。不要返回任何其他解释。如果找不到任何匹配项，请返回一个空数组 []。`;
                try {
                    const matchingIds = await callArkApi(prompt);
                    if (Array.isArray(matchingIds)) {
                        setSearchResultIds(matchingIds);
                    } else { throw new Error("AI返回了意料之外的格式。"); }
                } catch (err) {
                    console.error("日程安排AI查询错误:", err);
                    setError(err.message || "无法连接到AI服务。");
                    setSearchResultIds([]);
                } finally { setIsSearching(false); }
            };
            const clearSearch = () => { setSearchQuery(''); setSearchResultIds(null); setError(''); };
            
            // 决定最终要渲染的任务列表（优先显示搜索结果）
            const tasksToDisplay = searchResultIds !== null
                ? tasks.filter(task => searchResultIds.includes(task.id))
                : filteredAndSortedTasks;

            // 3. 定义筛选器按钮的数据
            const filters = [
                { key: 'all', label: '所有', count: null },
                { key: 'today', label: '今天', count: todayIncompleteCount },
                { key: 'tomorrow', label: '明天', count: tomorrowCount },
                { key: 'next10days', label: '未来10天', count: next10DaysCount },
                { key: 'next30days', label: '未来30天', count: next30DaysCount },
            ];

            return (
                <div className="h-full overflow-y-auto scrollbar-hide">
                    {/* 顶部搜索框 */}
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                        <div className="relative flex items-center gap-2 sm:gap-3">
                            <input type="text" inputMode="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isSearching && handleSearch()} placeholder="用自然语言搜索你的日程..." className="flex-grow p-3 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" disabled={isSearching}/>
                            <button onClick={handleSearch} disabled={isSearching || !searchQuery.trim()} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">{isSearching ? <Loader /> : <Search />}</button>
                        </div>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                        
                        {/* 4. 新增的筛选器 UI */}
                        <div className="mt-4 flex items-center gap-2 overflow-x-auto scrollbar-hide">
                            {filters.map(filter => (
                                <button
                                    key={filter.key}
                                    onClick={() => {
                                        setActiveFilter(filter.key);
                                        clearSearch(); // 点击筛选器时清除搜索结果
                                    }}
                                    className={`px-3 py-1.5 text-sm font-medium rounded-full transition-colors flex-shrink-0 whitespace-nowrap ${
                                        activeFilter === filter.key
                                            ? 'bg-blue-500 text-white'
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    {filter.label}
                                    {/* 仅当 count 不为 null 且大于0时显示数字 */}
                                    {filter.count !== null && filter.count > 0 && (
                                        <span className={`ml-1.5 px-1.5 py-0.5 text-xs rounded-full ${
                                            activeFilter === filter.key ? 'bg-white text-blue-500' : 'bg-gray-300 text-gray-800'
                                        }`}>
                                            {filter.count}
                                        </span>
                                    )}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* 任务卡片列表 */}
                    <main className="space-y-4 px-1">
                        {searchResultIds !== null && (
                            <div className="flex flex-wrap items-center gap-4 mb-4 px-2">
                                <span className="text-sm text-gray-500 flex-shrink-0">搜索结果:</span>
                                <div className="flex items-center gap-2"> 
                                    <span className="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 flex items-center gap-1.5"><Search size={14}/> "{searchQuery}"</span> 
                                    <button onClick={clearSearch} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button> 
                                </div>
                            </div>
                        )}
                        {isSearching ? (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><div className="flex justify-center items-center text-gray-500"><Loader className="mr-3" /><span>AI正在检索任务...</span></div></div>
                        ) : tasksToDisplay.length > 0 ? (
                            tasksToDisplay.map(task => 
                                <TaskCard 
                                    key={task.id} 
                                    task={task} 
                                    allTasks={tasks}
                                    {...props} 
                                />)
                        ) : (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><p className="text-gray-500">{searchResultIds !== null ? '根据你的描述，没有找到相关的日程。' : '当前筛选条件下没有任务。'}</p></div>
                        )}
                    </main>
                </div>
            );
        }

        function IdeasView({ tasks, allTasks, callArkApi, handleSaveGeneralInsight, ...props }) {
            const { handlers } = props;
            const [focusQuery, setFocusQuery] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const [searchResultIds, setSearchResultIds] = useState(null);
            const [error, setError] = useState('');
            const [selectedTag, setSelectedTag] = useState(null);
            const [selectedTaskType, setSelectedTaskType] = useState(null);
            const [selectedLocationScene, setSelectedLocationScene] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [isIdeaChatOpen, setIsIdeaChatOpen] = useState(false);

            const sortedIdeas = useMemo(() => sortByCreatedAt(tasks), [tasks]);
            const ideasCount = sortedIdeas.length;

            const filteredByTagsIdeas = useMemo(() => {
                return sortedIdeas.filter(task => {
                    const tagMatch = selectedTag ? task.tags && task.tags.includes(selectedTag) : true;
                    const context = task.context;
                    const isNewContext = typeof context === 'object' && context !== null;
                    const taskTypeMatch = selectedTaskType ? isNewContext && context.taskType === selectedTaskType : true;
                    const locationSceneMatch = selectedLocationScene ? isNewContext && context.locationScene === selectedLocationScene : true;
                    const categoryMatch = selectedCategory ? isNewContext && context.category === selectedCategory : true;
                    return tagMatch && taskTypeMatch && locationSceneMatch && categoryMatch;
                });
            }, [sortedIdeas, selectedTag, selectedTaskType, selectedLocationScene, selectedCategory]);
            
            const displayedIdeas = searchResultIds !== null 
                ? sortedIdeas.filter(idea => searchResultIds.includes(idea.id)) 
                : filteredByTagsIdeas;

            const handleIdeaSearch = async () => {
                if (!focusQuery.trim()) return;
                setIsThinking(true);
                setSearchResultIds(null);
                setError('');
                setSelectedTag(null);
                setSelectedTaskType(null);
                setSelectedLocationScene(null);
                setSelectedCategory(null);

                const prompt = `你是一个智能想法筛选助手。请根据用户的自然语言请求，从下面的想法列表中找出所有语义上匹配的条目。请重点分析想法的'title'和'rawText'字段。- 用户请求: '${focusQuery}' - 想法列表 (JSON): ${JSON.stringify(tasks.map(({isNew, ...rest}) => rest))} 请严格只返回一个包含所有匹配项ID的JSON数组 (e.g., [2, 8])。不要返回任何其他解释。如果找不到任何匹配项，请返回一个空数组 []。`;
                try {
                    const matchingIds = await callArkApi(prompt);
                    if (Array.isArray(matchingIds)) {
                        setSearchResultIds(matchingIds);
                    } else { throw new Error("AI返回了意料之外的格式。"); }
                } catch (err) {
                    console.error("想法空间AI查询错误:", err);
                    setError(err.message || "无法连接到AI服务。");
                    setSearchResultIds([]);
                } finally { setIsThinking(false); }
            };

            const clearSearch = () => { setFocusQuery(''); setSearchResultIds(null); setError(''); };
            const handleTagClick = (tag) => { setSelectedTag(tag); clearSearch(); };
            const handleTaskTypeClick = (type) => { setSelectedTaskType(type); clearSearch(); };
            const handleLocationSceneClick = (env) => { setSelectedLocationScene(env); clearSearch(); };
            const handleCategoryClick = (cat) => { setSelectedCategory(cat); clearSearch(); };

            return (
                <div className="h-full overflow-y-auto scrollbar-hide">
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                        <div className="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 mb-4">
                            <h2 className="text-xl sm:text-2xl font-semibold text-gray-700">生活想法</h2>
                            <div className="flex items-center gap-3">
                                <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                                    已记录 {ideasCount}个想法
                                </span>
                            </div>
                        </div>
                        <div className="relative flex items-center gap-2 sm:gap-3">
                            <input type="text" value={focusQuery} onChange={(e) => setFocusQuery(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isThinking && handleIdeaSearch()} placeholder="用自然语言搜索你的生活想法..." className="flex-grow p-3 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" disabled={isThinking}/>
                            <button onClick={handleIdeaSearch} disabled={isThinking || !focusQuery.trim()} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">{isThinking ? <Loader /> : <Search />}</button>
                            <button onClick={() => setIsIdeaChatOpen(true)} title="智慧再发芽" className="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition-all duration-200 ease-in-out flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">
                                <SproutIcon />
                            </button>
                        </div>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    <main className="space-y-4 px-1">
                        {(selectedTag || selectedTaskType || selectedLocationScene || selectedCategory || searchResultIds !== null) && (
                            <div className="flex flex-wrap items-center gap-4 mb-4 px-2">
                                <span className="text-sm text-gray-500 flex-shrink-0">筛选:</span>
                                {searchResultIds !== null && ( <div className="flex items-center gap-2"> <span className="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 flex items-center gap-1.5"><Search size={14}/> 搜索: "{focusQuery}"</span> <button onClick={clearSearch} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button> </div> )}
                                {selectedTag && ( <div className="flex items-center gap-2"><span className={`px-2 py-1 text-xs font-medium rounded-full ${handlers.getTagColor(selectedTag)}`}>{selectedTag}</span><button onClick={() => setSelectedTag(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button></div> )}
                                {selectedTaskType && ( <div className="flex items-center gap-2"><span className="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800 flex items-center gap-1.5"><Target size={14}/> {selectedTaskType}</span><button onClick={() => setSelectedTaskType(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button></div> )}
                                {selectedLocationScene && ( <div className="flex items-center gap-2"><span className="px-2 py-1 text-xs font-medium rounded-full bg-sky-100 text-sky-800 flex items-center gap-1.5"><Layers size={14}/> {selectedLocationScene}</span><button onClick={() => setSelectedLocationScene(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button></div> )}
                                {selectedCategory && ( <div className="flex items-center gap-2"> <span className={`px-2 py-1 text-xs font-medium rounded-full ${selectedCategory === '工作' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>{selectedCategory}</span> <button onClick={() => setSelectedCategory(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button> </div> )}
                            </div>
                        )}

                        {isThinking ? (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><div className="flex justify-center items-center text-gray-500"><Loader className="mr-3" /><span>AI正在检索想法...</span></div></div>
                        ) : displayedIdeas.length > 0 ? (
                            displayedIdeas.map(idea => 
                                <TaskCard 
                                    key={idea.id} 
                                    task={idea} 
                                    {...props} 
                                    allTasks={tasks}
                                    onTagClick={handleTagClick} 
                                    onEnergyClick={handleTaskTypeClick} 
                                    onEnvironmentClick={handleLocationSceneClick}
                                    onCategoryClick={handleCategoryClick}
                                />)
                        ) : (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md">
                                <p className="text-gray-500">
                                    {searchResultIds !== null ? '根据你的描述，没有找到相关的想法。' : (tasks.length === 0 ? '你的想法空间还是空的，快来添加一些灵感吧！' : '没有找到匹配筛选条件的想法。')}
                                </p>
                            </div>
                        )}
                    </main>
                    <IdeaChatModal
                        isOpen={isIdeaChatOpen}
                        onClose={() => setIsIdeaChatOpen(false)}
                        ideas={sortedIdeas}
                        allTasks={allTasks}
                        callArkApi={callArkApi}
                        handleSaveGeneralInsight={handleSaveGeneralInsight}
                        ideaType="life"
                    />
                </div>
            );
        }
        
        function WorkRecordsView({ tasks, allTasks, callArkApi, handleSaveGeneralInsight, ...props }) {
            const { handlers } = props;
            const [activeFilterTag, setActiveFilterTag] = useState(null);
            const [focusQuery, setFocusQuery] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const [searchResultIds, setSearchResultIds] = useState(null);
            const [error, setError] = useState('');
            const [selectedTaskType, setSelectedTaskType] = useState(null);
            const [selectedLocationScene, setSelectedLocationScene] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [isIdeaChatOpen, setIsIdeaChatOpen] = useState(false);

            const sortedIdeas = useMemo(() => sortByCreatedAt(tasks), [tasks]);
            const ideasCount = sortedIdeas.length;

            const filteredIdeas = useMemo(() => {
                if (!activeFilterTag) {
                    return sortedIdeas; // 如果没有筛选，返回所有
                }
                return sortedIdeas.filter(task => task.notebooks && task.notebooks.includes(activeFilterTag));
            }, [sortedIdeas, activeFilterTag]);

            const displayedIdeas = searchResultIds !== null 
                ? sortedIdeas.filter(idea => searchResultIds.includes(idea.id)) 
                : filteredIdeas;

            const handleIdeaSearch = async () => {
                if (!focusQuery.trim()) return;
                setActiveFilterTag(null);
                setIsThinking(true);
                setSearchResultIds(null);
                setError('');

                const searchableRecords = tasks.map(record => {
                    const project = allTasks.find(p => p.id === record.projectId);
                    return {
                        id: record.id,
                        title: record.title,
                        rawText: record.rawText,
                        projectName: project ? project.title : null
                    };
                });

                const prompt = `你是一个智能工作记录筛选助手。请根据用户的自然语言请求，从下面的工作记录列表中找出所有语义上匹配的条目。请重点分析每条记录的 'title', 'rawText', 以及它所属的 'projectName' 字段。- 用户请求: '${focusQuery}' - 工作记录列表 (JSON): ${JSON.stringify(searchableRecords)} 请严格只返回一个包含所有匹配项ID的JSON数组 (e.g., [2, 8])。不要返回任何其他解释。如果找不到任何匹配项，请返回一个空数组 []。`;
                try {
                    const matchingIds = await callArkApi(prompt);
                    if (Array.isArray(matchingIds)) {
                        setSearchResultIds(matchingIds);
                    } else { throw new Error("AI返回了意料之外的格式。"); }
                } catch (err) {
                    console.error("工作记录AI查询错误:", err);
                    setError(err.message || "无法连接到AI服务。");
                    setSearchResultIds([]);
                } finally { setIsThinking(false); }
            };

            const handleFilterClick = (tag) => {
                setActiveFilterTag(tag);
                setFocusQuery('');
                setSearchResultIds(null);
                setError('');
            };
            return (
                <div className="h-full overflow-y-auto scrollbar-hide">
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                        <div className="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 mb-4">
                            <h2 className="text-xl sm:text-2xl font-semibold text-gray-700">工作记录</h2>
                            <div className="flex items-center gap-3">
                                <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">
                                    已记录 {ideasCount}条
                                </span>
                            </div>
                        </div>
                        <div className="relative flex items-center gap-2 sm:gap-3">
                            <input type="text" value={focusQuery} onChange={(e) => setFocusQuery(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isThinking && handleIdeaSearch()} placeholder="用自然语言搜索你的工作记录..." className="flex-grow p-3 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" disabled={isThinking}/>
                            <button onClick={handleIdeaSearch} disabled={isThinking || !focusQuery.trim()} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">{isThinking ? <Loader /> : <Search />}</button>
                            <button onClick={() => setIsIdeaChatOpen(true)} title="智慧再发芽" className="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition-all duration-200 ease-in-out flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">
                                <SproutIcon />
                            </button>
                        </div>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    <main className="space-y-4 px-1">
                    {/* --- START: 全新简化的筛选状态显示 --- */}
                    {activeFilterTag && (
                        <div className="flex flex-wrap items-center gap-4 mb-4 px-2">
                            <span className="text-sm text-gray-500 flex-shrink-0">筛选:</span>
                            <div className="flex items-center gap-2">
                                <span className="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 flex items-center gap-1.5">
                                    {activeFilterTag}
                                </span>
                                <button onClick={() => setActiveFilterTag(null)} className="text-gray-400 hover:text-gray-600"><XCircleIcon size={16} /></button>
                            </div>
                        </div>
                    )}
                    {/* --- END: 替换结束 --- */}

                        {isThinking ? (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md"><div className="flex justify-center items-center text-gray-500"><Loader className="mr-3" /><span>AI正在检索记录...</span></div></div>
                        ) : displayedIdeas.length > 0 ? (
                            displayedIdeas.map(idea => 
                                <TaskCard 
                                    
                                    key={idea.id} 
                                    task={idea} 
                                    {...props} 
                                    allTasks={tasks}
                                    onFilterClick={handleFilterClick}
                                />)
                        ) : (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md">
                                <p className="text-gray-500">
                                    {searchResultIds !== null ? '根据你的描述，没有找到相关的工作记录。' : (tasks.length === 0 ? '还没有任何工作记录，快来添加吧！' : '没有找到匹配筛选条件的工作记录。')}
                                </p>
                            </div>
                        )}
                    </main>
                    <IdeaChatModal
                        isOpen={isIdeaChatOpen}
                        onClose={() => setIsIdeaChatOpen(false)}
                        ideas={displayedIdeas}
                        activeFilter={activeFilterTag}
                        allTasks={allTasks}
                        callArkApi={callArkApi}
                        handleSaveGeneralInsight={handleSaveGeneralInsight}
                        ideaType="work" 
                    />
                </div>
            );
        }

        function AwaitingView({ tasks, handlers }) {
            const { openTaskViewModal, sendAtomicUpdate, requestDelete } = handlers;

            const followUpItems = useMemo(() => {
                const items = tasks.filter(t => t.type === 'follow_up');
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                return items.sort((a, b) => {
                    if (a.isCompleted !== b.isCompleted) {
                        return a.isCompleted ? 1 : -1;
                    }

                    const aDate = new Date(a.dueDate.replace(/-/g, '/'));
                    const bDate = new Date(b.dueDate.replace(/-/g, '/'));

                    if (!a.isCompleted) {
                        const aIsOverdue = aDate < now;
                        const bIsOverdue = bDate < now;
                        if (aIsOverdue !== bIsOverdue) {
                            return aIsOverdue ? -1 : 1;
                        }
                        return aDate - bDate;
                    }
                    
                    return bDate - aDate;
                });
            }, [tasks]);

            const toggleFollowUpCompletion = (item) => {
                sendAtomicUpdate('update', { id: item.id, isCompleted: !item.isCompleted }, 'task', `切换跟进项完成状态: ${item.title}`);
            };
            
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString.replace(/-/g, '/'));
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                // --- 新增代码: 计算“后天”的日期 ---
                const dayAfterTomorrow = new Date(tomorrow);
                dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
                
                const datePart = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                const isMidnight = date.getHours() === 0 && date.getMinutes() === 0;
                
                const timeString = isMidnight 
                    ? '' 
                    : ` ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                if (date < now && !isMidnight) return '已逾期';
                if (datePart < today) return '已逾期';
                if (datePart.getTime() === today.getTime()) return `今天${timeString}`;
                if (datePart.getTime() === tomorrow.getTime()) return `明天${timeString}`;
                // --- 新增代码: 判断是否为“后天” ---
                if (datePart.getTime() === dayAfterTomorrow.getTime()) return `后天${timeString}`;
                
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + timeString;
            };
            
            const getStatusColor = (dateString, isCompleted) => {
                if (isCompleted) return 'bg-green-100 text-green-800';
                const date = new Date(dateString.replace(/-/g, '/'));
                const now = new Date();
                if (date < now) return 'bg-red-100 text-red-800';
                return 'bg-blue-100 text-blue-800';
            };

            return (
                <div className="h-full overflow-y-auto scrollbar-hide">
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                        <h2 className="text-xl sm:text-2xl font-semibold text-gray-700">等待反馈</h2>
                        <p className="text-sm text-gray-500 mt-1">这里是你需要跟进的所有事项。</p>
                    </div>

                    <main className="space-y-3 px-1">
                        {followUpItems.length > 0 ? (
                            followUpItems.map(item => {
                                const parentTask = tasks.find(t => t.id === item.parentId);
                                return (
                                    <div key={item.id} className={`bg-white rounded-xl shadow-md p-4 transition-all duration-300 ${item.isCompleted ? 'opacity-50' : ''}`}>
                                        <div className="flex items-start gap-4">
                                            <input
                                                type="checkbox"
                                                checked={item.isCompleted}
                                                onChange={() => toggleFollowUpCompletion(item)}
                                                className="h-6 w-6 rounded border-gray-300 text-blue-500 focus:ring-blue-500 cursor-pointer mt-1 flex-shrink-0"
                                            />
                                            <div className="flex-grow min-w-0">
                                                <p className="font-semibold text-gray-800">{item.title}</p>
                                                <p className="text-sm text-gray-500 mt-1">
                                                    等待 <span className="font-medium text-gray-700">{item.assignee}</span>
                                                </p>
                                                {parentTask && (
                                                    <p 
                                                        onClick={(e) => { e.stopPropagation(); openTaskViewModal(parentTask); }}
                                                        className="text-xs text-blue-600 hover:underline cursor-pointer mt-2 truncate"
                                                        title={parentTask.title}
                                                    >
                                                        来自主任务: {parentTask.title}
                                                    </p>
                                                )}
                                            </div>
                                            {/* --- START: 这是我们新增和修改的部分 --- */}
                                            <div className="flex flex-col items-end space-y-2 flex-shrink-0">
                                                <div className={`text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap ${getStatusColor(item.dueDate, item.isCompleted)}`}>
                                                    {formatDate(item.dueDate)}
                                                </div>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation(); // 防止点击事件冒泡触发其他行为
                                                        requestDelete(item.id);
                                                    }}
                                                    className="text-gray-400 hover:text-red-500 p-1"
                                                    title="删除此跟进项"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                            {/* --- END: 修改结束 --- */}
                                        </div>
                                    </div>
                                );
                            })
                        ) : (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md">
                                <p className="text-gray-500">太棒了！没有需要等待的事项。</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        function ProjectsView({ tasks, handlers, sendAtomicUpdate, callArkApi, expandedRawTextId }) {
            const { requestDelete } = handlers;
            
            const [newProjectName, setNewProjectName] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [expandedProjectId, setExpandedProjectId] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [isCreating, setIsCreating] = useState(false);

            const items = useMemo(() => sortByCreatedAt(tasks.filter(t => t.type !== 'project')), [tasks]);

            const projects = useMemo(() => {
                const projectTasks = tasks.filter(t => t.type === 'project');
                const findLatestUpdate = (projectId) => {
                    const projectItems = items.filter(item => item.projectId === projectId);
                    if (projectItems.length === 0) {
                        const project = projectTasks.find(p => p.id === projectId);
                        return project ? new Date(project.createdAt).getTime() : 0;
                    }
                    return Math.max(...projectItems.map(item => new Date(item.createdAt).getTime()));
                };

                return projectTasks.sort((a, b) => {
                    if (a.isCompleted !== b.isCompleted) {
                        return a.isCompleted ? 1 : -1;
                    }
                    if (a.isCompleted) {
                        const dateA = a.completionDate ? new Date(a.completionDate).getTime() : 0;
                        const dateB = b.completionDate ? new Date(b.completionDate).getTime() : 0;
                        return dateB - dateA;
                    } else {
                        const lastUpdateA = findLatestUpdate(a.id);
                        const lastUpdateB = findLatestUpdate(b.id);
                        return lastUpdateB - lastUpdateA;
                    }
                });
            }, [tasks, items]);

            const uncompletedCount = projects.filter(p => !p.isCompleted).length;
            const completedCount = projects.filter(p => p.isCompleted).length;  

            const filteredProjects = useMemo(() => {
                if (!searchQuery.trim()) return projects;
                return projects.filter(p => p.title.toLowerCase().includes(searchQuery.toLowerCase()));
            }, [projects, searchQuery]);

            const handleCreateProject = async () => {
                if (!newProjectName.trim()) return;
                setIsLoading(true);
                setError('');

                const prompt = `你是一个文本分析助手。请从以下用户输入中提取一个简洁、明确的项目标题。
用户输入: "${newProjectName}"
请严格按照JSON格式返回，只包含一个 "title" 键。例如: {"title": "提取出的项目标题"}`;

                try {
                    const aiResponse = await callArkApi(prompt);
                    if (!aiResponse.title) {
                        throw new Error("AI未能返回预期的标题。");
                    }

                    const newProject = {
                        id: Date.now() + Math.random(),
                        createdAt: new Date().toISOString(),
                        rawText: newProjectName,
                        type: 'project',
                        title: aiResponse.title,
                        isCompleted: false,
                        savedInsights: [],
                        isNew: true
                    };
                    sendAtomicUpdate('create', newProject, 'task', `创建新项目: ${newProject.title}`);
                    setNewProjectName('');
                    setIsCreating(false);
                } catch (err) {
                    console.error("创建项目时出错:", err);
                    setError("AI分析失败，已为你创建一个基础项目。");
                    const fallbackProject = {
                        id: Date.now() + Math.random(),
                        createdAt: new Date().toISOString(),
                        rawText: newProjectName,
                        type: 'project',
                        title: newProjectName,
                        isCompleted: false,
                        savedInsights: [],
                        isNew: true
                    };
                    sendAtomicUpdate('create', fallbackProject, 'task', `创建备用项目: ${fallbackProject.title}`);
                    setNewProjectName('');
                    setIsCreating(false);
                } finally {
                    setIsLoading(false);
                }
            };

            const toggleProjectExpansion = (projectId) => {
                setExpandedProjectId(prevId => (prevId === projectId ? null : projectId));
            };
            
            const ProjectCard = ({ project, handlers, expandedRawTextId }) => {
                const [isTitleExpanded, setIsTitleExpanded] = useState(false);
                const isRawTextExpanded = expandedRawTextId === project.id;

                const getItemDate = (item) => {
                    if (item.type === 'task' && item.startDate) return new Date(item.startDate.replace(/-/g, '/'));
                    return new Date(item.createdAt);
                };
                
                const formatCompletionDate = (dateString) => {
                    if (!dateString) return '';
                    const d = new Date(dateString);
                    return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                };

                const projectItems = items.filter(item => item.projectId === project.id);
                const transactionCount = projectItems.filter(item => item.type === 'task').length;
                const ideaCount = projectItems.filter(item => item.type === 'idea').length;

                const isExpanded = expandedProjectId === project.id;
                
                return (
                    <div className={`bg-white rounded-xl shadow-md p-4 sm:p-5 transition-all duration-300 ${project.isCompleted ? 'opacity-60' : ''} ${project.isNew ? 'ring-2 ring-green-400 bg-green-50' : ''}`}>
                        <div className="flex items-start gap-4">
                            <div className="flex-shrink-0 flex flex-col items-center pt-1.5 space-y-4"> 
                                <input 
                                    type="checkbox"
                                    checked={!!project.isCompleted}
                                    onClick={(e) => e.stopPropagation()} 
                                    onChange={(e) => { e.stopPropagation(); handlers.toggleProjectCompletion(project.id); }}
                                    className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                    title={project.isCompleted ? "标记为未完成" : "标记为已完成"}
                                />
                                <button onClick={(e) => { e.stopPropagation(); requestDelete(project.id); }} className="text-gray-400 hover:text-red-500 p-1 mt-auto" title="删除项目"><Trash2 size={16} /></button>
                            </div>

                            <div className="flex-grow min-w-0 flex flex-col">
                                <div className="flex justify-between items-start">
                                    <div className="flex-grow min-w-0">
                                        <p
                                            className={`text-base sm:text-lg font-semibold text-gray-800 pr-2 cursor-pointer ${!isTitleExpanded ? 'truncate' : 'whitespace-normal'}`}
                                            onClick={() => setIsTitleExpanded(!isTitleExpanded)}
                                            title="点击展开/折叠标题"
                                        >
                                            {project.title}
                                        </p>
                                        <div className="mt-2">
                                            <p className={`text-xs sm:text-sm text-gray-400 raw-text-expandable ${isRawTextExpanded ? 'whitespace-normal' : 'truncate'}`} onClick={() => {
                                                if (window.getSelection().toString().length === 0) {
                                                    handlers.toggleRawText(project.id);
                                                }
                                            }}>
                                                原始记录: {project.rawText}
                                            </p>
                                            {isRawTextExpanded && (
                                                <div className="mt-3 space-y-3">
                                                    <button onClick={() => handlers.openReshapeModal(project)} className="flex items-center gap-1.5 px-2 py-1 text-xs text-purple-700 bg-purple-50 hover:bg-purple-100 rounded-md transition-colors">
                                                        <Sparkles size={14}/>
                                                        <span>补充</span>
                                                    </button>
                                                    {(project.savedInsights && project.savedInsights.length > 0) && (
                                                        <div className="p-3 bg-gray-50 rounded-lg">
                                                            <h4 className="text-xs font-semibold text-gray-700 mb-2 flex items-center gap-1.5"><BrainCircuit size={14} className="text-blue-500"/>AI 洞察</h4>
                                                            <div className="space-y-3">
                                                                {project.savedInsights.map(insight => (
                                                                    <div key={insight.id} className="text-sm border-l-2 border-blue-200 pl-3">
                                                                        <div className="assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(insight.content) }} />
                                                                        <div className="mt-2 flex justify-between items-center">
                                                                            <p className="text-xs text-gray-400">{`保存于 ${formatCreationTime(insight.savedAt)}`}</p>
                                                                            <button onClick={() => handlers.handleDeleteInsight(project.id, insight.id)} className="text-gray-400 hover:text-red-500" title="删除此条洞察">
                                                                                <Trash2 size={14}/>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex-shrink-0 cursor-pointer p-1" onClick={() => toggleProjectExpansion(project.id)}>
                                        {isExpanded ? <ChevronLeft size={20} className="transform -rotate-90"/> : <ChevronRight size={20} />}
                                    </div>
                                </div>
                                
                                {project.isCompleted && project.completionDate && (
                                    <div className="flex items-center gap-1.5 text-green-600 text-xs sm:text-sm mt-2">
                                        <Check size={16} />
                                        <span>完成于 {formatCompletionDate(project.completionDate)}</span>
                                    </div>
                                )}
                                
                                <div 
                                    className="flex items-center justify-between mt-4 pt-4 border-t border-gray-100 cursor-pointer"
                                    onClick={() => toggleProjectExpansion(project.id)}
                                >
                                    <div className="flex items-center gap-x-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">
                                        {transactionCount > 0 && (<div className="flex items-center gap-1.5"><List className="w-4 h-4" /><span>{`${transactionCount} 个事务`}</span></div>)}
                                        {ideaCount > 0 && (<div className="flex items-center gap-1.5"><Lightbulb className="w-4 h-4 text-orange-400" /><span>{`${ideaCount} 个想法`}</span></div>)}
                                    </div>
                                    <button
                                        onClick={(e) => { e.stopPropagation(); handlers.handleGetAssistance(project); }}
                                        className="flex items-center gap-1.5 px-2 py-1 text-xs text-green-700 bg-green-50 hover:bg-green-100 rounded-md transition-colors flex-shrink-0 ml-4"
                                        title="AI 分析此项目"
                                    >
                                        <Bot size={14}/>
                                        <span>AI 建议</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {isExpanded && (() => {
                            const sortedItems = [...projectItems].sort((a, b) => getItemDate(b) - getItemDate(a));
                            const getItemTypeInfo = (item) => {
                                if (item.type === 'idea') return { name: '想法', className: 'bg-orange-100 text-orange-800' };
                                if (item.type === 'work_record') return { name: '记录', className: 'bg-indigo-100 text-indigo-800' };
                                if (item.type === 'task' && item.startDate) return { name: '日程', className: 'bg-blue-100 text-blue-800' };
                                return { name: '待办', className: 'bg-green-100 text-green-800' };
                            };

                            return (
                                <div className="mt-4 pt-4 border-t border-gray-100">
                                    {projectItems.length > 0 ? (
                                        <ul className="space-y-2">
                                            {sortedItems.map(item => {
                                                const typeInfo = getItemTypeInfo(item);
                                                return (
                                                    <li 
                                                        key={item.id} 
                                                        className="flex items-center justify-between bg-gray-50 p-2.5 rounded-md hover:bg-gray-200 transition-colors duration-200 cursor-pointer"
                                                        onClick={(e) => { e.stopPropagation(); handlers.openTaskViewModal(item); }}
                                                    >
                                                        <div className="flex items-center gap-3 min-w-0">
                                                            <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${typeInfo.className} w-12 text-center flex-shrink-0`}>{typeInfo.name}</span>
                                                            <span className="text-sm text-gray-800 truncate">{item.title}</span>
                                                        </div>
                                                        <span className="text-xs text-gray-500 flex-shrink-0 ml-3">{new Date(getItemDate(item)).toLocaleDateString('zh-CN', {month:'2-digit', day:'2-digit'})}</span>
                                                    </li>
                                                );
                                            })}
                                        </ul>
                                    ) : (
                                        <p className="text-sm text-gray-400 text-center py-2">该项目下还没有任何条目。</p>
                                    )}
                                </div>
                            );
                        })()}
                    </div>
                );
            };

            return (
                <div className="h-full overflow-y-auto scrollbar-hide">
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sticky top-0 z-10">
                        <div className="flex flex-wrap items-baseline justify-between gap-x-4 gap-y-2 mb-4">
                            <h2 className="text-xl sm:text-2xl font-semibold text-gray-700">项目管理</h2>
                            <div className="flex items-center gap-3">
                                <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                    未完成 {uncompletedCount}个
                                </span>
                                <span className="px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    {completedCount}个已完成
                                </span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 sm:gap-3">
                            <div className="relative flex-grow">
                                <input type="text" inputMode="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="搜索项目名称..." className="w-full p-3 pl-10 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition"/>
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Search size={20} /></div>
                            </div>
                            <button onClick={() => setIsCreating(true)} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2 text-sm flex-shrink-0">
                                <Plus size={18} />
                                <span className="hidden sm:inline">新项目</span>
                            </button>
                        </div>

                        {isCreating && (
                            <div className="mt-4 pt-4 border-t border-gray-200">
                                <div className="relative flex items-center gap-2 sm:gap-3">
                                    <input type="text" value={newProjectName} onChange={(e) => setNewProjectName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && !isLoading && handleCreateProject()} placeholder="详细描述你的新项目..." className="flex-grow p-3 text-base bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" disabled={isLoading} autoFocus/>
                                    <button onClick={handleCreateProject} disabled={isLoading || !newProjectName.trim()} className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 disabled:bg-blue-300 flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">
                                        {isLoading ? <Loader /> : <Plus />}
                                    </button>
                                </div>
                                {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                                <div className="text-center mt-2">
                                    <button onClick={() => setIsCreating(false)} className="text-xs text-gray-500 hover:text-gray-700">取消</button>
                                </div>
                            </div>
                        )}
                    </div>

                    <main className="space-y-4 px-1">
                        {filteredProjects.length > 0 ? (
                            filteredProjects.map(project => <ProjectCard key={project.id} project={project} handlers={handlers} expandedRawTextId={expandedRawTextId} />)
                        ) : (
                            <div className="text-center py-10 px-4 bg-white rounded-xl shadow-md">
                                <p className="text-gray-500">{searchQuery ? '没有找到匹配的项目。' : '还没有任何项目，快来创建一个吧！'}</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        
        function AssistantView({ allTasks, callArkApi, handleSaveGeneralInsight }) {
            const initialMessage = { role: 'assistant', content: '你好！有什么可以帮你的吗？请先选择我能访问的数据范围，然后向我提问吧。' };
            const [messages, setMessages] = useState(() => {
                try {
                    const savedMessages = localStorage.getItem('assistant_chat_history');
                    if (savedMessages && JSON.parse(savedMessages)[0]?.content !== initialMessage.content) {
                       return [initialMessage];
                    }
                    if (savedMessages) {
                        return JSON.parse(savedMessages);
                    }
                } catch (e) {
                    console.error("无法加载聊天记录:", e);
                }
                return [initialMessage];
            });
            const [userInput, setUserInput] = useState('');
            const [isThinking, setIsThinking] = useState(false);
            const [error, setError] = useState('');
            const [dataSources, setDataSources] = useState({ tasks: true, ideas: false, projects: true });
            const [showPresetPrompts, setShowPresetPrompts] = useState(messages.length === 1);
            const chatContainerRef = useRef(null);
            const chatEndRef = useRef(null);
            const abortControllerRef = useRef(null);

            const presetPrompts = [
                `作为我的日程规划师，请帮我安排今天剩余时间合适处理的事务（现在时间是：${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}），步骤：1. 找出今天已固定的任务。2. 找出空闲时段。3. 从我的待办和项目中选择任务填充。4. 以清晰的时间线格式呈现。请不要使用表格。时间格式用24小时制`,
                "作为我的日程规划师，请为我制定一份明天的详细时间表（请不要使用表格，而是用要点列表，不用展示给我看太多的的分析）。步骤：1. 找出明天已固定的任务。2. 找出空闲时段。3. 从我的待办和项目中选择任务填充。4. 以清晰的时间线格式呈现。",
                "找出一些可以在30分钟内完成，并且能显著推动项目前进的“顺手”任务。",
                "检查我的所有项目，有没有因为缺少某个任务或想法而停滞不前的？"
            ];

            useEffect(() => {
                try {
                    localStorage.setItem('assistant_chat_history', JSON.stringify(messages));
                } catch (e) {
                    console.error("无法保存聊天记录:", e);
                }
            }, [messages]);

            useEffect(() => {
                const container = chatContainerRef.current;
                if (!container) return;
                const lastMessage = messages[messages.length - 1];

                // 检查用户是否在底部
                const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 100;

                // 如果是用户刚发送消息，或用户停留在底部，则自动滚动
                if ((lastMessage && lastMessage.role === 'user') || isScrolledToBottom) {
                    chatEndRef.current?.scrollIntoView({ block: 'end' });
                }
            }, [messages]);

            const handleDataSourceChange = (e) => {
                const { name, checked } = e.target;
                setDataSources(prev => ({ ...prev, [name]: checked }));
            };

            const handleStopGeneration = () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }
            };

            const handleNewChat = () => {
                handleStopGeneration();
                setMessages([initialMessage]);
                setShowPresetPrompts(true);
                localStorage.removeItem('assistant_chat_history'); 
            };
            
            const callApiForResponse = async (history) => {
                setIsThinking(true);
                setError('');
                abortControllerRef.current = new AbortController();

                let contextData = [];
                if (dataSources.tasks) contextData.push(...allTasks.filter(t => t.type === 'task'));
                if (dataSources.ideas) contextData.push(...allTasks.filter(t => t.type === 'Idea' || t.type === 'work_idea'));
                if (dataSources.projects) contextData.push(...allTasks.filter(t => t.type === 'project'));
                
                const contextString = contextData.length > 0 ? `这是可用的数据:\n${JSON.stringify(contextData.map(({ id, isNew, ...rest }) => rest))}` : "没有可用的数据。";
                
                const apiMessages = [
                    { role: "system", content: `你是Bingo的私人助理。请分析我提供的数据上下文，并根据我的问题回答。请用友好、口语化的语气，直接给我核心的建议或洞察。请使用 Markdown 格式来突出重点。\n\n今天的日期是: ${new Date().toLocaleDateString('sv')}\n\n# 数据上下文\n${contextString}` },
                    ...history.filter(msg => msg.content !== initialMessage.content).map(({ role, content }) => ({ role, content }))
                ];

                try {
                    setMessages(prev => [...prev, { role: 'assistant', content: '' }]);
                    const reader = await callArkApi({ messages: apiMessages, stream: true }, true, abortControllerRef.current.signal);
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.substring(6);
                                if (jsonStr.trim() === '[DONE]') break;
                                try {
                                    const parsed = JSON.parse(jsonStr);
                                    if (parsed.choices && parsed.choices[0].delta.content) {
                                        const contentChunk = parsed.choices[0].delta.content;
                                        setMessages(prev => {
                                            const newMessages = [...prev];
                                            newMessages[newMessages.length - 1].content += contentChunk;
                                            return newMessages;
                                        });
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                } catch (err) {
                     if (err.name === 'AbortError') {
                        setMessages(prev => {
                            const newMessages = [...prev];
                            const lastMsg = newMessages[newMessages.length-1];
                            if (lastMsg && lastMsg.role === 'assistant' && lastMsg.content === '') {
                                lastMsg.content = '已停止回答。';
                            }
                            return newMessages;
                        });
                    } else {
                        console.error("AI 助理出错:", err);
                        const errorMessage = "抱歉，我好像遇到了一点问题，请稍后再试。";
                        setMessages(prev => {
                            const newMessages = [...prev];
                            const lastMsg = newMessages[newMessages.length-1];
                            if (lastMsg && lastMsg.role === 'assistant' && lastMsg.content === '') {
                                lastMsg.content = errorMessage;
                            }
                            return newMessages;
                        });
                        setError(err.message || "AI服务暂时不可用。");
                    }
                } finally {
                    setIsThinking(false);
                    abortControllerRef.current = null;
                }
            };
            
            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!userInput.trim() || isThinking) return;

                setShowPresetPrompts(false);
                const newUserMessage = { role: 'user', content: userInput };
                const currentHistory = [...messages, newUserMessage];
                setMessages(currentHistory);
                setUserInput('');
                await callApiForResponse(currentHistory);
            };

            const handlePresetClick = async (prompt) => {
                if (isThinking) return;
                setShowPresetPrompts(false);
                const newUserMessage = { role: 'user', content: prompt };
                const currentHistory = [...messages, newUserMessage];
                setMessages(currentHistory);
                await callApiForResponse(currentHistory);
            };

            return (
                <main className="flex flex-col h-full">
                    <div className="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 flex-shrink-0">
                         <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                <span className="text-sm font-medium text-gray-600">数据源:</span>
                                <label className="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="tasks" checked={dataSources.tasks} onChange={handleDataSourceChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"/>
                                    <span className="text-sm text-gray-700">事务</span>
                                </label>
                                 <label className="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="ideas" checked={dataSources.ideas} onChange={handleDataSourceChange} className="h-4 w-4 rounded border-gray-300 text-orange-500 focus:ring-orange-500"/>
                                    <span className="text-sm text-gray-700">想法</span>
                                </label>
                                <label className="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="projects" checked={dataSources.projects} onChange={handleDataSourceChange} className="h-4 w-4 rounded border-gray-300 text-indigo-500 focus:ring-indigo-500"/>
                                    <span className="text-sm text-gray-700">项目</span>
                                </label>
                            </div>
                            <button onClick={handleNewChat} title="开启新对话" className="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors">
                                <RefreshCw size={16} />
                            </button>
                        </div>
                    </div>

                    <div ref={chatContainerRef} className="flex-grow bg-white rounded-xl shadow-lg p-4 overflow-y-auto flex flex-col space-y-4 min-h-0">
                        {messages.map((msg, index) => {
                            if (msg.role === 'user') {
                                return (
                                    <div key={index} className="flex justify-end">
                                        <div className="max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl bg-blue-500 text-white">
                                            <div className="assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}></div>
                                        </div>
                                    </div>
                                );
                            }
                            if (msg.role === 'assistant' && msg.content) {
                                const isSaved = allTasks.some(t => t.type === 'insight' && t.content === msg.content);
                                
                                return (
                                    <div key={index} className="flex flex-col items-start w-full">
                                        <div className="w-full max-w-xs md:max-w-md lg:max-w-lg">
                                            <div className="px-4 py-3 rounded-2xl bg-gray-100 text-gray-800">
                                                {(isThinking && index === messages.length - 1 && !msg.content) ? 
                                                    (<div className="flex items-center gap-2"><Loader size={16}/><span>正在思考...</span></div>) :
                                                    (<div className="assistant-output" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content) }}></div>)
                                                }
                                            </div>
                                            {!isThinking && msg.content !== initialMessage.content && (
                                                <div className="w-full flex justify-end mt-2 pr-1">
                                                    <button 
                                                        onClick={() => {
                                                            const lastUserMsg = [...messages].slice(0, index).reverse().find(m => m.role === 'user');
                                                            handleSaveGeneralInsight(msg.content, lastUserMsg ? lastUserMsg.content : '无对应问题');
                                                        }}
                                                        disabled={isSaved}
                                                        className={`flex items-center gap-1.5 px-3 py-1 text-xs rounded-full transition-colors ${
                                                            isSaved 
                                                            ? 'bg-green-100 text-green-700' 
                                                            : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        <Bookmark size={14} className={isSaved ? "fill-current" : ""}/>
                                                        <span>{isSaved ? "已收藏" : "收藏"}</span>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            }
                            return null;
                        })}

                        {showPresetPrompts && messages.length === 1 && (
                            <div className="pt-2 space-y-2">
                                {presetPrompts.map((prompt, index) => (
                                    <button
                                        key={index}
                                        onClick={() => handlePresetClick(prompt)}
                                        className="w-full text-left p-3 bg-gray-50 hover:bg-gray-200 rounded-lg text-sm text-gray-700 transition-colors"
                                    >
                                        <span className="line-clamp-2">{prompt}</span> 
                                    </button>
                                ))}
                            </div>
                        )}
                        
                        {isThinking && messages[messages.length - 1].role === 'user' && (
                             <div className="flex items-end gap-2 justify-start">
                                <div className="max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl bg-gray-100 text-gray-800">
                                   <div className="flex items-center gap-2"><Loader size={16}/><span>正在思考...</span></div>
                                </div>
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </div>

                    <form onSubmit={handleSendMessage} className="mt-4 flex-shrink-0">
                        <div className="relative flex items-center gap-2 sm:gap-3">
                            <input
                                type="text"
                                inputMode="text"
                                value={userInput}
                                onChange={(e) => setUserInput(e.target.value)}
                                placeholder="在这里输入你的问题..."
                                className="flex-grow p-3 text-base bg-white rounded-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
                                disabled={isThinking}
                            />
                            {isThinking ? (
                                <button type="button" onClick={handleStopGeneration} className="bg-red-500 text-white p-3 rounded-xl shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition-all duration-200 ease-in-out flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">
                                    <Square size={20} />
                                </button>
                            ) : (
                                <button type="submit" disabled={!userInput.trim()} className="bg-blue-500 text-white p-3 rounded-xl shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 flex-shrink-0">
                                    <Send size={20} />
                                </button>
                            )}
                        </div>
                         {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </form>
                </main>
            );
        }

        function SettingsView({ handleExportData, handleImportData, workRecordNotebooks, sendAtomicUpdate }) {
            const [newNotebook, setNewNotebook] = useState('');

            const handleAddNewNotebook = () => {
                if (newNotebook && !workRecordNotebooks.includes(newNotebook)) {
                    const updatedNotebooks = [...workRecordNotebooks, newNotebook];
                    // 向服务器发送更新请求
                    sendAtomicUpdate('updateAll', updatedNotebooks, 'notebook', '添加新笔记本');
                    setNewNotebook('');
                }
            };

            const handleDeleteNotebook = (notebookToDelete) => {
                if (window.confirm(`确定要删除笔记本 "${notebookToDelete}" 吗？`)) {
                    const updatedNotebooks = workRecordNotebooks.filter(nb => nb !== notebookToDelete);
                    // 向服务器发送更新请求
                    sendAtomicUpdate('updateAll', updatedNotebooks, 'notebook', `删除笔记本: ${notebookToDelete}`);
                }
            };
            
            const fileInputRef = useRef(null);
            
            return (
                 <main className="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 className="text-xl sm:text-2xl font-semibold text-gray-700 mb-6">设置</h2>
                    <div className="space-y-4">
                         <div>
                            <h3 className="text-lg font-medium text-gray-800">数据管理</h3>
                            <p className="text-sm text-gray-500 mt-1">备份您的数据，或从备份文件中恢复。</p>
                            <div className="mt-4 flex gap-4">
                               <button onClick={handleExportData} className="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 flex items-center justify-center text-sm">
                                    <Upload size={16} className="mr-2"/> 导出数据
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 flex items-center justify-center text-sm">
                                    <Download size={16} className="mr-2"/> 导入数据
                                </button>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleImportData}
                                    className="hidden"
                                    accept=".json"
                                />
                            </div>
                             <p className="text-xs text-gray-400 mt-2">注意：导入操作会覆盖当前所有数据。</p>
                        </div>
                        {/* --- START: 新增的笔记本管理模块 --- */}
                        <div className="mt-6 border-t pt-6">
                            <h3 className="text-lg font-medium text-gray-800">笔记本管理</h3>
                            <p className="text-sm text-gray-500 mt-1">管理“工作记录”的分类笔记本，AI 将会使用这些分类。</p>
                            <div className="mt-4 flex gap-4">
                                <input
                                    type="text"
                                    value={newNotebook}
                                    onChange={(e) => setNewNotebook(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleAddNewNotebook()}
                                    placeholder="输入新笔记本名称"
                                    className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none"
                                />
                                <button 
                                    onClick={handleAddNewNotebook}
                                    className="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600 flex items-center justify-center text-sm"
                                >
                                    <Plus size={16} className="mr-2"/> 添加
                                </button>
                            </div>
                            <div className="mt-4 space-y-2">
                                {workRecordNotebooks.map(notebook => (
                                    <div key={notebook} className="flex items-center justify-between bg-gray-100 p-2 rounded-md">
                                        <span className="text-sm text-gray-700">{notebook}</span>
                                        <button onClick={() => handleDeleteNotebook(notebook)} className="text-gray-400 hover:text-red-500">
                                            <Trash2 size={16} />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {/* --- END: 新增模块结束 --- */}

                    </div>
                </main>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
